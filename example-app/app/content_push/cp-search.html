<!--
superclass for elements which perform searches; subclasses of this component
should implement a searchImpl() method (see cp-search-wikipedia.html
for an example)
-->
<polymer-element name="cp-search"
                 attributes="resultsPerFetch">
  <script src="cp-resultset.js"></script>
  <script>
    (function () {
      // declare the element
      Polymer({
        // number of results to return when fetch() is invoked
        resultsPerFetch: 10,

        created: function () {
          // map from key phrases to ResultSets
          this.queries = {};
        },

        /* does the book-keeping for tracking result sets per query;
           searchImpl() is called inside here, and should set the
           offset on the ResultSet so that searches can be paged */
        search: function (query, sourceURL) {
          var self = this;
          var key = query + (sourceURL || '');

          // have we searched for this before?
          var resultSet = this.queries[key] || new ResultSet(key);

          try {
            var promise = this.searchImpl(resultSet, query, sourceURL);

            return promise.then(
              function (resultSet) {
                self.queries[key] = resultSet;
                return Promise.resolve(resultSet)
              },

              function (err) {
                return Promise.reject(err);
              }
            );
          } catch (err) {
            return Promise.reject(err);
          }
        },

        /*
          returns a promise which resolves to the next numResults
          images from the ResultSet associated with the key phrase query;
          if results aren't available, performs a search first then returns
          results from that
        */
        fetch: function (query, sourceURL) {
          var promise;
          var results;
          var key = query + (sourceURL || '');

          var resultsPerFetch = this.resultsPerFetch;
          var resultSet = this.queries[key];

          if (resultSet) {
            if (resultSet.isExhausted) {
              /* no results */
              promise = Promise.resolve([]);
            } else if (resultSet.count() >= resultsPerFetch) {
              /* fetch next batch of results (no search required) */
              results = resultSet.fetch(resultsPerFetch);
              promise = Promise.resolve(results);
            }
          }

          if (!promise || !promise.resolved) {
            /* get more results */
            promise = this.search(query, sourceURL).then(
              function (resultSet) {
                results = resultSet.fetch(resultsPerFetch);
                return Promise.resolve(results);
              },

              function (error) {
                return Promise.reject(error);
              }
            );
          }

          return promise;
        }
      });
    })();
  </script>
</polymer-element>
