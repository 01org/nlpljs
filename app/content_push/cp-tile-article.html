<!--
tile for a general web page (article)
-->
<polymer-element name="cp-tile-article" attributes="src loaded done">
  <template>
    <link rel="stylesheet" href="styles/cp-tile.css">

    <style>
      #text {
        height: 100%;
        width: 100%;
      }

      #text > * {
        margin: 0 12px;
      }

      #image {
        overflow: hidden;
      }

      img {
        height: 100%;
        width: auto;
      }

      .text-elide {
        overflow: hidden;
        text-overflow: ellipsis;

        /* these provide the multi-line ellipsis over 2 lines, but
           only work in WebKit; as we're dependent on Chrome, I decided it
           was OK */
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 2;
      }

      .left {
        width: 36% !important;
      }

      .right {
        width: 64% !important;
      }

      #meta {
        position: absolute;
        bottom: 4px;
      }

      #meta p {
        margin: 0.25em 0;
      }
    </style>

    <div id="container">
      <div horizontal layout fit>
        <div id="image" class="left"
             data-show="{{src !== null && imageLoaded}}">
          <img src="{{src}}" on-load="{{onImageLoaded}}"
               on-error="{{onImageError}}">
        </div>

        <div id="text"
             class="{{src === null || !imageLoaded ? '' : 'right'}}">
          <h2 id="caption" class="text-elide">
            {{caption|stripHTMLTags}}
          </h2>

          <p id="snippet" class="text-elide">
            {{snippet|stripHTMLTags}}
          </p>

          <div id="meta">
            <p id="source" class="small">
              {{sourceName || source|domainFromURL}}
            </p>
          </div>
        </div>
      </div>
    </div>

  </template>

  <script src="./cp-layout-frame-chooser.js"></script>
  <script src="./cp-formatter.js"></script>

  <script>
    (function () {
      Polymer({
        created: function () {
          /* THESE PROPERTIES SHOULD BE SET WHEN THE TILE IS CREATED */

          /* URL for the file thumbnail to be displayed */
          this.src = null;

          /* title to show at the bottom of the tile */
          this.caption = '';

          /* snippet of the article */
          this.snippet = null;

          /* source */
          this.source = null;

          /* source name; if not set, defaults to the domain of
             the source attribute */
          this.sourceName = null;

          /* the original data used to construct the tile, as
             returned by a file search */
          this.article = {};

          /* keyword associated with the image with structure:
             {
               text: "<keyword text>",
               groupId: "<keyword group ID>"
             }
          */
          this.keywords = [];

          /* PROPERTIES BELOW DON'T NEED TO BE SET */

          /* type of object used to create the tile */
          this.type = 'article';

          /* always use the landscape frame */
          this.frame = FrameChooser.FRAMES['landscape1'];

          /* set to true once the image loads, which enables the
             image part of the tile to be shown */
          this.imageLoaded = false;

          /* set to true once the image has either loaded or not;
             this must be true otherwise the tile won't display at all */
          this.loaded = false;

          /* article tiles are ready regardless of whether the image
             loads; we just change how they look if it doesn't */
          this.done = false;
        },

        srcChanged: function () {
          var self = this;

          this.loaded = false;
          this.imageLoaded = false;

          /* fire a "done" event, even if the image times out */
          setTimeout(function () {
            if (!self.loaded) {
              self.done = true;
              self.fire('done');
            }
          }, CP_CONSTANTS.TIMEOUT);
        },

        onImageLoaded: function () {
          this.imageLoaded = true;
          this.loaded = true;
          this.done = true;
          this.fire('done', this);
        },

        /* image failed to load for whatever reason */
        onImageError: function (e) {
          this.imageLoaded = false;

          /* we still mark the tile as "loaded" so it will display */
          this.loaded = true;
          this.done = true;
          this.fire('done', this);

          /* notify the error, in case anyone cares */
          this.fire('error', e);
        },

        domainFromURL: Formatter.domainFromURL,

        stripHTMLTags: Formatter.stripHTMLTags
      });
    })();
  </script>
</polymer-element>
