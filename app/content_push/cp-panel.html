<link rel="import" href="../bower_components/core-toolbar/core-toolbar.html">
<link rel="import" href="../bower_components/core-icon-button/core-icon-button.html">
<link rel="import" href="../bower_components/core-icon/core-icon.html">
<link rel="import" href="../bower_components/core-header-panel/core-header-panel.html">
<link rel="import" href="../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/core-icons/core-icons.html">
<link rel="import" href="../bower_components/core-icons/av-icons.html">
<link rel="import" href="../bower_components/core-icons/editor-icons.html">
<link rel="import" href="./cp-aggregator.html">
<link rel="import" href="./cp-display.html">
<link rel="import" href="./cp-image-detail.html">
<link rel="import" href="./cp-swapper.html">
<link rel="import" href="./cp-sources-groups.html">

<polymer-element name='cp-panel' on-newkeywordinfo='{{onNewKeywordInfo}}'>
  <template>
    <style>
      :host {
        height: 100%;
      }

      #toolbar {
        display: flex;
        flex-direction: column;
        height: 7%;
        background-color: #202020;
        margin: 0;
        padding: 0;
        z-index: 500;
      }

      #toolbartext {
        color: #FFFFFF;
        -webkit-user-select: none;
        font-size: 0.5em;
      }

      #toolbaricon {
        margin-right: 0;
      }

      #toolbaraction {
        color: #FFFFFF;
        -webkit-user-select: none;
      }

      #display {
        margin: 3px;
        padding: 0;
        height: 93%;
        width: 100%;
        overflow: hidden;
        box-sizing: border-box;
      }

      cp-swapper {
        width: 100%;
        height: 100%;
      }

      cp-image-detail {
        background-color: white;
      }

      #menu {
        padding: 0;
        margin-left: 0;
      }

      #menu::shadow core-icon, core-icon {
        color: white;
      }

      #menu::shadow core-dropdown, core-dropdown {
        left: 12px;
      }

      [data-show="false"] {
        display: none;
      }
    </style>
    <cp-swapper id="swapper">
      <div swapper-fix>
        <!-- the panel is made up of a header toolbar and the display -->
        <core-toolbar id="toolbar">
          <!-- items in this menu set the "types" part of the display filter -->
          <paper-menu-button id="menu" icon="menu" on-click="{{applyTypeFilter}}">
            <paper-item icon="drive-image" label="Images"
                        data-type-filter="image"></paper-item>
            <paper-item icon="editor:format-color-text" label="Quotations"
                        data-type-filter="quotation"></paper-item>
            <paper-item icon="drive-file" label="Files"
                        data-type-filter="file"></paper-item>
            <paper-item icon="av:movie" label="Videos"
                        data-type-filter="video"></paper-item>
            <paper-item icon="folder" label="Text+Images"
                        data-type-filter="quotation,image"></paper-item>
            <paper-item icon="apps" label="All"
                        data-type-filter="no-filter"></paper-item>
            <paper-item icon="editor:mode-edit" label="EDIT SOURCES"
                        data-type-filter="edit"></paper-item>
          </paper-menu-button>

          <core-icon id="toolbaricon" icon="" data-show="false"></core-icon>
          <span id="toolbartext" flex>Content Push</span>

          <core-icon-button id="toolbaraction" icon="close" on-tap="{{closePanel}}"></core-icon-button>
        </core-toolbar>

        <cp-display id="display"
                    on-moreresults="{{onDisplayMoreResults}}"
                    on-mouse-over="{{onDisplayMouseover}}"
                    on-mouse-out="{{onDisplayMouseout}}"
                    on-mouse-down="{{showDetail}}"
                    on-slider-change="{{sliderChange}}">
        </cp-display>
      </div>

      <cp-image-detail id="detail" on-back="{{closeDetail}}"
                       swapper-slide swap-id="detail">
      </cp-image-detail>

      <cp-sources-groups id="groups"
                  on-back="{{closeGroups}}"
                  swapper-slide swap-id="groups">
      </cp-sources-groups>
    </cp-swapper>

    <cp-aggregator id="aggregator"
                   on-receivedresults="{{onReceivedResults}}"
                   on-searchfailed="{{onSearchFailed}}"
                   on-nopendingsearches="{{onNoPendingSearches}}">
    </cp-aggregator>
  </template>

  <script>
    (function cpPanel () {
      // private *static* functions and constants

      var setFilter = function (self) {
        if (!self.activeKeywords) {
          return;
        }

        var sliderValue = self.$.display.$.slider.value;
        var desiredNumber = Math.floor((sliderValue / (100 - sliderValue)) *
          self.activeKeywords.length);

        /* set filter on the display based on current keywordInfo
           and selected result types */
        self.$.display.setFilter({
          activeKeywords: self.activeKeywords.slice(0, desiredNumber),
          types: self.typeFilter
        });
      };

      /* perform search for current keyphrase and add to the display */
      var search = function (self, newKeywords) {
        if (!self.activeKeywords) {
          return;
        }

        self.$.display.wait();
        self.$.aggregator.aggregate(newKeywords);
      };

      /* tests whether the active keywords have changed;
       * returns an array of new keywords.
       */
      var checkKeywordInfoChanged = function (oldKeywordInfo, newKeywordInfo) {
        /* no keyword set yet, so definitely a change */
        if (!oldKeywordInfo) {
          return newKeywordInfo.keywords;
        }

        var newKeywords = [];
        var keywords = oldKeywordInfo.map(function (keyword) {
          return keyword.text;
        });

        for (var i = 0; i < newKeywordInfo.keywords.length; i++) {
          if (keywords.indexOf(newKeywordInfo.keywords[i].text) === -1)
            newKeywords[newKeywords.length] = newKeywordInfo.keywords[i];
        }

        return newKeywords;
      };

      Polymer({
        // functions and properties used in API and bindings
        created: function () {
          this.activeKeywords = null;

          /* an array of types of result to show in the display,
             or empty array to have no filter set */
          this.typeFilter = [];
        },

        // called from content-push.html:trackAction() when splitter moves
        layout: function () {
          this.$.display.layout();
        },

        showDetail: function (e) {
          this.$.detail.showTile(e.detail);
          this.$.swapper.slideIn('detail');
        },

        closeDetail: function () {
          this.$.swapper.slideOut('detail');
        },

        closeGroups: function () {
          this.$.swapper.slideOut('groups');
        },

        /* change which types of result are displayed when a menu
           item is clicked */
        applyTypeFilter: function (e) {
          /* only respond to events on elements with a data-type-filter
             attribute */
          var elt = e.toElement;
          var typeFilter = elt.getAttribute('data-type-filter');
          if (!typeFilter) {
            return;
          }

          if (typeFilter === 'edit') {
            console.log('edit sources');
            this.$.swapper.slideIn('groups');
            return;
          }

          /* switch title bar text based on menu item selection */
          if (typeFilter === 'no-filter') {
            this.typeFilter = [];
            this.$.toolbaricon.icon = '';
            this.$.toolbaricon.setAttribute('data-show', 'false');
            this.$.toolbartext.innerHTML = 'Content Push';
          } else {
            this.typeFilter = typeFilter.split(',');
            this.$.toolbaricon.icon = elt.icon;
            this.$.toolbaricon.setAttribute('data-show', 'true');
            this.$.toolbartext.innerHTML = elt.label;
          }

          setFilter(this);
        },

        /* keywordInfo event occurred on the document */
        onNewKeywordInfo: function (e) {
          console.log('PA:onNewKeywordInfo', e.detail.keywordInfo);

          var newKeywords =
            checkKeywordInfoChanged(this.activeKeywords, e.detail.keywordInfo);

          this.activeKeywords = e.detail.keywordInfo.keywords;

          /* if we have new keywords, run a fresh search */
          if (newKeywords.length > 0) {
            this.$.display.scrollToTop();
            search(this, newKeywords);
          }
        },

        /* search more using current keywordInfo */
        onDisplayMoreResults: function () {
          search(this, this.activeKeywords);
        },

        onDisplayMouseover: function (e) {
          this.fire('mouseoverimage', e.detail);
        },

        onDisplayMouseout: function (e) {
          this.fire('mouseoutimage', e.detail);
        },

        /* the first result which loads successfully into a tile
           will turn off the waiting indicator on cp-display */
        onReceivedResults: function (e) {
          this.$.display.receiveResults(e.detail.results);
          setFilter(this);
        },

        onSearchFailed: function (e) {
          /* TODO notify user of search errors in UI */
          this.$.display.receiveResults([]);
          console.error(e.detail.error);
          setFilter(this);
        },

        /* if the aggregator has finished searching, ensure the
           waiting indicator on cp-display is off, even if no results
           were found */
        onNoPendingSearches: function () {
          console.log('CP-PANEL: got nopendingsearches');
          this.$.display.stopWaiting();
        },

        closePanel: function () {
          this.fire('close-panel');
        },

        sliderChange: function () {
          setFilter(this);
        }
      }); // Polymer()
    })();
  </script>
</polymer-element>
