<link rel="import" href="../bower_components/core-header-panel/core-header-panel.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input-decorator.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="./cp-sources-storage.html">

<polymer-element name="cp-sources-selector">
  <template>
    <style>
      :host {
        display: block;
        position: relative;
        display: inline-block;
        height: 100%;
        width: 100%;
        overflow-y: auto;
      }

      #title-back {
        margin-top: 30px;
      }

      #panel_overlay {
        position:absolute;
        top:0px;
        left:0px;
        bottom:0px;
        right:0px;
        background-color:rgba(0, 0, 0, 0.5);
        z-index: 5;
        visibility: hidden;
      }

      #panel {
        height: 100%;
        width: 100%;
      }

      #panel::shadow #dropShadow {
        box-shadow: none !important;
      }

      #header {
        background-color: #B8578C;
        text-align: left;
        color: white;
        padding-top: 30px;
      }

      #headertext {
        margin-left: 15px;
        font-size: 20px;
      }

      #back {
        padding-left: 0 !important;
      }

      #add {
        background-color: #FFF373;
        bottom:-20px;
        z-index:1;
      }

      #add[disabled] {
        background-color: #c9c9c9;
      }

      #add::shadow core-icon, core-icon {
        color: black;
      }

      #select_all_container {
        padding-top: 45px;
        padding-bottom: 20px;
        width: calc(100% - 48px);
        margin-left: 24px;
        border-bottom: 1px solid #afafaf;
        font-size: 14px;
      }

      #sources {
        width: calc(100% - 48px);
        margin-left: 24px;
      }

      #sources div {
        padding-top: 8px;
        padding-bottom: 8px;
        align-items: center;
        font-size: 14px;
      }

      #sources div:first-child {
        padding-top: 14px;
      }

      #sources core-icon {
        color: gray;
        width: 16px;
        height: 16px;
      }

      paper-dialog {
        left: 0;
        right: 0;
        width: 200px;
        height: 150px;
        margin: auto;
        display: flex;
      }

      #add_dialog::shadow #container {
        padding: 0;
        max-height: 100%;
        max-width: 100%;
        width: 100%;
        height: 100%;
      }

      #add_dialog::shadow #main {
        padding: 0;
        max-height: 100%;
        max-width: 100%;
        width: 100%;
        height: 100%;
      }

      #add_dialog::shadow #actions {
        padding: 0;
      }

      #add_dialog paper-input-decorator {
        padding: 0;
        width: 70%;
        height: 35%;
        margin: auto;
        font-size: 70%;
      }

      #add_dialog_button_wrapper {
        width:70%;
        height:30%;
        margin: auto;
      }

      #add_dialog_button_wrapper paper-button {
        font-size: 70%;
        text-align: center;
        width: 30%;
        height: 70%;
        margin: auto;
      }

      paper-checkbox {
        margin-right: 32px;
      }

      paper-checkbox::shadow #checkboxContainer {
        width: 18px;
        height: 18px;
      }

      paper-checkbox::shadow #checkbox.checked {
        border-color: #B8578C;
      }
    </style>

    <div id="panel_overlay"></div>

    <cp-sources-storage id="storage" on-new-sources="{{onNewSources}}"></cp-sources-storage>

    <core-header-panel id="panel">
      <core-toolbar id="header" class="medium-tall">
        <div vertical layout>
          <div id="title-back" horizontal layout center>
            <paper-icon-button id="back" icon="arrow-back"
                              on-tap="{{onBackButtonClick}}">
            </paper-icon-button>

            <div flex>
              <div id="headertext">Sources</div>
            </div>
          </div>
          <paper-fab
            id="add"
            icon="add"
            disabled?="{{currentType==='Files'}}"
            on-click="{{onAddClick}}">
          </paper-fab>
        </div>
      </core-toolbar>

      <div id="select_all_container" horizontal layout>
        <paper-checkbox
          id="select_all"
          disabled?="{{currentType==='Files'}}"
          on-change="{{enableAllSources}}">
        </paper-checkbox>
        <div flex>Select All</div>
      </div>

      <div id="sources" vertical layout></div>

      <paper-dialog id="add_dialog" flex transition="paper-dialog-transition-center" autoCloseDisabled="{{true}}">
        <paper-input-decorator label="Source Name" floatingLabel error="input is required!">
          <input is="core-input" required>
        </paper-input-decorator>

        <paper-input-decorator label="Source URL" floatingLabel error="input is required!">
          <input is="core-input" required>
        </paper-input-decorator>

        <div id="add_dialog_button_wrapper" horizontal justified layout>
          <paper-button id="cancel" dismissive on-click="{{onAddCancelClick}}">Cancel</paper-button>
          <paper-button id="done" on-click="{{onAddDoneClick}}">Done</paper-button>
        </div>
      </paper-dialog>
    </core-header-panel>
  </template>

  <script>
    (function () {
      var updateSelectAllStatus = function (self, type) {
        var allDisabled = true;
        var allEnabled = true;

        if (self.currentType !== '' && self.sources !== null) {
          var sourceGroup = self.getSourceGroup(type);

          for (var i in sourceGroup.sources) {
            var source = self.sources[type].sources[i];

            if (source.enabled) {
              allDisabled = false;
            } else {
              allEnabled = false;
            }
          }

          if (Object.keys(sourceGroup.sources).length === 0)
            allEnabled = false;

        } else {
          allEnabled = false;
        }

        if (self.$.select_all.getAttribute("checked") === null &&
            allEnabled === true) {
          self.$.select_all.toggle();
        } else
        if (self.$.select_all.getAttribute("checked") !== null &&
            allDisabled === true) {
          self.$.select_all.toggle();
        } else
        if (self.$.select_all.getAttribute("checked") !== null &&
            allEnabled === false) {
          self.$.select_all.toggle();
        }
      };

      var onAddSource = function (self, name, url, type, enabled) {
        var wrapper = document.createElement("div");
        var checkbox = document.createElement("paper-checkbox");
        var listItem = document.createElement("div");
        var trash = document.createElement("core-icon");
        var icon = document.createAttribute("icon");

        listItem.innerText = name;
        listItem.setAttributeNode(document.createAttribute("flex"));

        icon.value = "delete";
        trash.setAttributeNode(icon);

        wrapper.setAttributeNode(document.createAttribute("horizontal"));
        wrapper.setAttributeNode(document.createAttribute("layout"));

        if (self.currentType==='Files') {
          checkbox.setAttribute('disabled','');
          trash.setAttribute('disabled','');
        } else {
          checkbox.addEventListener("change", function () {
            onCheckboxToggled(self, name, type,
              checkbox.getAttribute("checked") !== null);
          });

          trash.addEventListener("click", function () {
            onRemoveSource(self, name, type, wrapper);
          });
        }

        if (enabled === true)
          checkbox.toggle();

        wrapper.appendChild(checkbox);
        wrapper.appendChild(listItem);
        wrapper.appendChild(trash);

        self.$.sources.appendChild(wrapper);
      };

      var onAddDialogClose = function (self) {
        var inputFields = self.$.add_dialog.querySelectorAll("paper-input-decorator");

        self.$.panel_overlay.style.visibility = "hidden";

        for (var i = 0; i < inputFields.length; i++) {
          inputFields[i].querySelector("input").value = '';
          inputFields[i].querySelector("input").commit();
          inputFields[i].isInvalid = false;
          inputFields[i].focusedChanged();
        }
      };

      var onRemoveSource = function (self, name, type, sourceWrapper) {
        self.$.sources.removeChild(sourceWrapper);

        delete self.sources[type].sources[name];

        self.$.storage.sources = self.sources;

        self.changes[self.changes.length] = {
          type: "sourceremoved",
          detail: {
            name: name,
            type: type
          }
        };

        updateSelectAllStatus(self, type);
      };

      var onCheckboxToggled = function (self, sourceName, sourceType, isChecked) {
        var selectAll = self.$.select_all;
        var isEnabled = self.sources[sourceType].sources[sourceName].enabled;

        if (isChecked !== isEnabled) {
          if (isChecked) {
            self.changes[self.changes.length] = {
              type: "sourceenabled",
              detail: {
                name: sourceName,
                type: sourceType
              }
            };
          } else {
            self.changes[self.changes.length] = {
              type: "sourcedisabled",
              detail: {
                name: sourceName,
                type: sourceType
              }
            };
          }
        }

        if (self.sources[sourceType].sources[sourceName].enabled !==
            isChecked) {
          self.sources[sourceType].sources[sourceName].enabled = isChecked;
          self.$.storage.sources = self.sources;
        }

        updateSelectAllStatus(self, self.$.headertext.innerText);
      };

      Polymer({
        created: function() {
          this.sources = null;
          this.changes = [];
        },

        currentType: '',

        getSourceGroup: function (type) {
          if (!this.sources[type]) {
            this.sources[type] = {
              enabled: true,
              sources: {}
            };
          }

          return this.sources[type];
        },

        setGroup: function (type) {
          this.$.headertext.innerText = type;
          this.currentType = type;

          this.changes = [];

          if (this.currentType !== '' && this.sources !== null) {
            var sourceGroup = this.getSourceGroup(type);

            for (i in sourceGroup.sources) {
              var source = this.sources[type].sources[i];

              this.addSource(i, source.url, type, source.enabled);
            }
          }

          updateSelectAllStatus(this, type);
        },

        addSource: function (name, url, type, enabled) {
          onAddSource(this, name, url, type, enabled);
        },

        enableAllSources: function () {
          var checkboxes = this.$.sources.querySelectorAll("paper-checkbox");
          var allEnabled = this.$.select_all.getAttribute("checked") !== null;

          for (var i = 0; i < checkboxes.length; i++) {
            var sourceEnabled = checkboxes[i].getAttribute("checked") !== null;

            if ((allEnabled === true && sourceEnabled === false) ||
                (allEnabled === false && sourceEnabled === true)) {
              checkboxes[i].toggle();
              checkboxes[i].fire("change");
            }
          };
        },

        onNewSources: function () {
          this.sources = this.$.storage.sources;
          this.setGroup(this.currentType);

          for (i in this.sources) {
            for (j in this.sources[i].sources) {
              var source = this.sources[i].sources[j];

              this.changes[this.changes.length] = {
                type: "sourceadded",
                detail: {
                  name: j,
                  url: source.url,
                  type: i
                }
              };

              if (source.enabled === true) {
                this.changes[this.changes.length] = {
                  type: "sourceenabled",
                  detail: {
                    name: j,
                    type: i
                  }
                };
              }
            }
          }

          this.fire("sourcesedited", this.changes);
        },

        onBackButtonClick: function () {
          this.fire('close');

          if (this.changes.length > 0)
            this.fire("sourcesedited", this.changes);

          this.currentType = '';

          while (this.$.sources.hasChildNodes())
            this.$.sources.removeChild(this.$.sources.lastChild);
        },

        onAddClick: function () {
          this.$.panel_overlay.style.visibility = "visible";
          this.$.add_dialog.toggle();
        },

        onAddDoneClick: function () {
          var inputFields = this.$.add_dialog.querySelectorAll("paper-input-decorator");
          var valid = true;
          var name = inputFields[0].querySelector("input").committedValue;
          var url = inputFields[1].querySelector("input").committedValue;

          for (var i = 0; i < inputFields.length; i++) {
            inputFields[i].isInvalid = !inputFields[i].querySelector("input").validity.valid;

            var sourceGroup = this.getSourceGroup(this.currentType);

            if (sourceGroup.sources[name] && i === 0) {
              inputFields[i].isInvalid = true;
            }

            if (inputFields[i].isInvalid) {
              valid = false;
            }
          }

          if (valid === true) {
            this.$.add_dialog.toggle();

            onAddDialogClose(this);

            var sourceGroup = this.getSourceGroup(this.currentType);

            if (!sourceGroup) {
              this.sources[this.currentType] = {
                enabled: true,
                sources: {},
              };
            }

            this.sources[this.currentType].sources[name] = {
              enabled: true,
              url: url
            };

            this.$.storage.sources = this.sources;

            this.changes[this.changes.length] = {
              type: "sourceadded",
              detail: {
                name: name,
                url: url,
                type: this.currentType
              }
            };

            this.changes[this.changes.length] = {
              type: "sourceenabled",
              detail: {
                name: name,
                type: this.currentType
              }
            };

            this.addSource(name, url, this.currentType, true);

            this.fire("sourcesedited", this.changes);

            updateSelectAllStatus(this, this.currentType);
          }
        },

        onAddCancelClick: function () {
          onAddDialogClose(this);
        }
      });
    })();
  </script>
</polymer-element>
