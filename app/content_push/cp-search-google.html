<!--
search using a Google custom search engine
-->
<link rel="import" href="./cp-search.html">
<polymer-element name="cp-search-google" extends="cp-search"
                 attributes="searchType">
  <template>
    <cp-globals id="globals"></cp-globals>
  </template>

  <script src="jsonp.js"></script>
  <script src="cp-thumbnailer.js"></script>
  <script>
    (function () {
      /* maximum number of results Google will return per search */
      var MAX_RESULTS_PER_SEARCH = 10;

      Polymer({
        /* these are associated with sig.exp.london@gmail.com */
        key: "AIzaSyARyiQ40rIjCtqtamRW98McMrU1gFgDPDE",
        cx: "010167764530769062315:196d4y__4ss",

        /* search safe level */
        safe: 'high',

        /* search type: 'image' or 'article' */
        searchType: 'image',

        sourceURL: '',

        created: function () {
          this.super();
        },

        domReady: function () {
          this.appId = this.$.globals.data.app_id;
        },

        /* prepare results for query; returns a promise which resolves
           to a ResultSet for the query */
        searchImpl: function (resultSet, query, sourceURL) {
          var self = this;

          /* Google image results count from 1, whereas resultSet
             offsets start from 0 */
          var start = resultSet.offset + 1;

          var url = 'https://www.googleapis.com/customsearch/v1?' +
                    (this.searchType === 'image' ? 'searchType=image&' : '') +
                    'key=' + this.key + '&' +
                    'cx=' + this.cx + '&' +
                    'safe=' + this.safe + '&' +
                    'num=' + MAX_RESULTS_PER_SEARCH + '&' +
                    'start=' + start + '&' +
                    'q=%22' + query + '%22';

          if (sourceURL) {
            url += '&';

            // 'i' => include results from the specified site
            url += 'siteSearchFilter=i&' +
                   'siteSearch=' + encodeURIComponent(sourceURL);
          }

          console.log(url);

          return new Promise(function (resolve, reject) {
            var message = {
              component: 'http',
              url: url
            };

            chrome.runtime.sendMessage(self.appId, message, function (response) {
              self.handleResponse(resultSet, query, self.searchType, response)
              .then(
                resolve, reject
              );
            });
          });
        },

        /*
         * searchType: 'image' or 'article'
         * returns the resultSet, populated with the images from
         * response
         */
        handleResponse: function (resultSet, query, searchType, response) {
          if (response.error) {
            var err = new Error('CP:error from Google: ' +
                                JSON.stringify(response));
            return Promise.reject(err);
          } else if (response.items) {
            if (response.queries.nextPage) {
              /* offset for the next search for this query */
              var offset = response.queries.nextPage[0].startIndex - 1;

              /* NB another search may have already reset the offset
                 on the ResultSet, so use the biggest value */
              resultSet.setOffset(Math.max(offset, resultSet.offset));
            } else {
              resultSet.setExhausted();
            }

            var data;
            for (var i = 0; i < response.items.length; i++) {
              data = response.items[i];
              var result;

              if (searchType === 'image') {
                /* TODO doesn't seem to be any EXIF data on Google images */
                var meta = {};

                result = {
                  caption: data.title,
                  src: data.link,
                  thumbnailSrc: Thumbnailer.getGoogleURL(data.link),
                  width: data.image.width,
                  height: data.image.height,
                  type: searchType,
                  source: data.link,
                  meta: {
                    ExifVersion: (meta.ExifVersion ?
                                      meta.ExifVersion.value : null),
                    DateTime: (meta.DateTime ?
                                  formatDate(meta.DateTime.value) : null),
                    Camera: (meta.Model ? meta.Model.value.trim() : null)
                  }
                };
              } else if (searchType === 'article') {
                var thumbnailSrc;
                var src = null;
                if (data.pagemap && data.pagemap['cse_image']) {
                  src = data.pagemap['cse_image'];
                }

                if (src) {
                  src = src[0].src;
                  thumbnailSrc = Thumbnailer.getGoogleURL(src);
                } else {
                  src = null;
                  thumbnailSrc = null;
                }

                result = {
                  caption: data.title,
                  src: src,
                  thumbnailSrc: thumbnailSrc,
                  type: searchType,
                  source: data.link,
                  snippet: data.snippet
                };
              }

              resultSet.add(result);
            }
          } else {
            /* end of result set reached */
            resultSet.setExhausted();
          }

          return Promise.resolve(resultSet);
        }
      });
    })();
  </script>
</polymer-element>
