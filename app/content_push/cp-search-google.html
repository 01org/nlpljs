<!--
search using a Google custom search engine
-->
<link rel="import" href="./cp-search.html">
<polymer-element name="cp-search-google" extends="cp-search"
                 attributes="searchType">
  <script src="jsonp.js"></script>
  <script src="cp-thumbnailer.js"></script>
  <script>
    (function () {
      /* maximum number of results Google will return per search */
      var MAX_RESULTS_PER_SEARCH = 10;

      Polymer({
        /* these are associated with sig.exp.london@gmail.com */
        key: "AIzaSyARyiQ40rIjCtqtamRW98McMrU1gFgDPDE",
        cx: "010167764530769062315:196d4y__4ss",

        /* only one type of licence can be specified at a time
           (I discovered this through trial and error)... */
        rights: "cc_publicdomain",

        /* search safe level */
        safe: 'high',

        /* search type: 'image' or 'article' */
        searchType: 'image',

        created: function () {
          this.super();
        },

        /* prepare results for query; returns a promise which resolves
           to a ResultSet for the query */
        searchImpl: function (resultSet, query) {
          var self = this;

          /* Google image results count from 1, whereas resultSet
             offsets start from 0 */
          var start = resultSet.offset + 1;

          var url = 'https://www.googleapis.com/customsearch/v1?' +
                    (this.searchType === 'image' ? 'searchType=image&' : '') +
                    'key=' + this.key + '&' +
                    'cx=' + this.cx + '&' +
                    'safe=' + this.safe + '&' +
                    'num=' + MAX_RESULTS_PER_SEARCH + '&' +
                    'rights=' + this.rights + '&' +
                    'start=' + start + '&' +
                    'q=%22' + query + '%22';

          return new Promise(function (resolve, reject) {
            jsonp({
              url: url,
              cb: function (response) {
                self.handleResponse(resultSet, query, self.searchType, response)
                .then(resolve, reject);
              }
            });
          });
        },

        /*
         * searchType: 'image' or 'article'
         * returns the resultSet, populated with the images from
         * response
         */
        handleResponse: function (resultSet, query, searchType, response) {
          if (response.error) {
            var err = new Error('CP:error from Google: ' +
                                JSON.stringify(response));
            return Promise.reject(err);
          } else if (response.items) {
            if (response.queries.nextPage) {
              /* offset for the next search for this query */
              var offset = response.queries.nextPage[0].startIndex - 1;

              /* NB another search may have already reset the offset
                 on the ResultSet, so use the biggest value */
              resultSet.setOffset(Math.max(offset, resultSet.offset));
            } else {
              resultSet.setExhausted();
            }

            var data;
            for (var i = 0; i < response.items.length; i++) {
              data = response.items[i];

              /* TODO doesn't seem to be any EXIF data on Google images */
              var meta = {};

              resultSet.add({
                src: data.link,
                thumbnailSrc: Thumbnailer.getGoogleURL(data.link),
                width: data.image.width,
                height: data.image.height,
                type: searchType,
                caption: data.title,
                source: data.image.contextLink,
                meta: {
                  ExifVersion: (meta.ExifVersion ?
                                    meta.ExifVersion.value : null),
                  DateTime: (meta.DateTime ?
                                formatDate(meta.DateTime.value) : null),
                  Camera: (meta.Model ? meta.Model.value.trim() : null)
                }
              });
            }

          } else {
            /* end of result set reached */
            resultSet.setExhausted();
          }

          return Promise.resolve(resultSet);
        }
      });
    })();
  </script>
</polymer-element>
