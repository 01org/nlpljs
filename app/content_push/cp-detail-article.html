<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/core-icon/core-icon.html">
<link rel="import" href="../bower_components/core-icons/core-icons.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">

<polymer-element name="cp-detail-article" attributes="src caption source">
  <template>
    <link rel="stylesheet" href="./styles/cp-detail.css">

    <div id="container" vertical layout>
      <div id="back" horizontal layout>
        <paper-fab id="backbutton" mini icon="arrow-back" raisedButton="true"
                   on-click="{{onBackButtonClick}}">
        </paper-fab>

        <h2 id="backcaption" data-show="{{!!caption}}" flex>
          <caption>{{caption|stripHTMLTags}}</caption>
        </h2>
      </div>

      <div id="imgContainer" data-show="{{!!src}}">
        <div id="spinner" data-show="{{!loaded}}">
          <template if="{{!loaded}}">
            <paper-spinner active></paper-spinner>
          </template>
        </div>

        <img id="image" src="{{src}}" on-error="{{onImageError}}"
             on-load="{{onImageLoad}}" data-show="{{!!imageHasLoaded}}">
      </div>

      <h2 id="caption" data-show="{{!!caption}}">
        <caption>{{caption|stripHTMLTags}}</caption>
      </h2>

      <p id="articleSource" data-show="{{!!source}}">
        {{sourceName || source|domainFromURL}}
      </p>

      <div id="snippet" data-show="{{!!snippet}}">
        {{snippet|stripHTMLTags}}
      </div>

      <div id="spacer" flex></div>
      <hr id="hr">

      <div id="visitSrc" data-show="{{!!source}}">
        <paper-button class="colored" on-click="{{visitWebpage}}"
                      data-source-link="{{source}}">
          GO TO ARTICLE
        </paper-button>
      </div>

    </div>
  </template>

  <script src="./cp-constants.js"></script>
  <script src="./cp-formatter.js"></script>

  <script>
    (function () {
      Polymer({
        /* source URL of the file thumbnail */
        src: null,

        /* text describing the file */
        caption: null,

        /* where the file came from */
        source: null,

        /* name of the source */
        sourceName: null,

        /* extract from the article */
        snippet: null,

        created: function () {
          this.loaded = false;
          this.imageHasLoaded = false;
        },

        stripHTMLTags: Formatter.stripHTMLTags,

        domainFromURL: Formatter.domainFromURL,

        srcChanged: function () {
          var self = this;

          this.loaded = false;
          this.imageHasLoaded = false;

          /* if the image never loads, record the component as ready
             anyway, to ensure that it will display */
          setTimeout(function () {
            self.loaded = true;
          }, CP_CONSTANTS.TIMEOUT);
        },

        onImageLoad: function () {
          this.loaded = true;
          this.imageHasLoaded = true;
          this.fire('done');
        },

        onImageError: function () {
          this.loaded = true;
          this.imageHasLoaded = false;
          this.fire('done');
        },

        onBackButtonClick: function () {
          this.fire('back');
        },

        showTile: function (tile) {
          this.src = tile.article.src;
          this.caption = tile.article.caption;
          this.source = tile.article.source;
          this.sourceName = tile.article.sourceName;
          this.snippet = tile.article.snippet;
        },

        visitWebpage: function () {
          if (this.source) {
            window.open(this.source, '_blank');
          }
        },

        /* no clean-up necessary, but needed by the API */
        close: function () {}
      });
    })();
  </script>
</polymer-element>
