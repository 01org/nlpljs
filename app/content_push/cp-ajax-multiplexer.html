<!--
 - cp-ajax-multiplexer
 -
 - This element provides the functionality of calling core-ajax multiple
 - times with overlapping responses. The call to url() returns an id and
 - results are provided via a 'multi-response' event that includes that id
 - allowing the caller to associate the url() call with the response.
 -
 - <cp-ajax-multiplexer id="multiplexer"></core-ajax-multiplexter>
 - ...
 - this.$.multiplexer.addEventListener('multi-response', function(e) {
 -   var id = e.details.id;
 -   var response = e.detail.detail.response;
 - });
 - ...
 - id = this.$.multiplexer.url(myUrl); // automatically does 'go()'
 -->
<link rel='import' href='../bower_components/core-ajax/core-ajax.html'>

<polymer-element name='cp-ajax-multiplexer'>
  <script>
    (function coreAjaxMultiplexer() {
      var coreAjaxes=[]; // array of core-ajax elements
      var idleAjaxes=[]; // array of indexes into coreAjaxes, those that are idle

      function makeCallback(self, id) {
        var callback = function(e) {
          console.log('CP-AJAX-MULTIPLEXER: response for id:', id);
          self.fire('multi-response',{
            id: id,
            detail: e.detail
          });

          idleAjaxes.push(id);
        };

        return callback;
      };

      function findFreeCoreAjaxIndex() {
        var i=idleAjaxes.pop();

        if (i === undefined) {
          var coreAjax = makeNewCoreAjax();
          i = coreAjaxes.push(coreAjax)-1;
          console.log('CP-AJAX-MULTIPLEXER: coreAjaxes.length', coreAjaxes.length);
        }

        return i;
      };

      function makeNewCoreAjax() {
        var coreAjax = document.createElement('core-ajax');
        coreAjax.setAttribute('auto','');
        coreAjax.setAttribute('handleAs','json');

        return coreAjax;
      };

      Polymer({
        ready: function() {
          // make one ajax and make it idle
          var newCoreAjax = makeNewCoreAjax();
          var newIndex = coreAjaxes.push( newCoreAjax )-1;
          idleAjaxes.push( newIndex );
          console.log('CP-AJAX-MULTIPLEXER: coreAjaxes.length', coreAjaxes.length);
          console.log('CP-AJAX-MULTIPLEXER: idleAjaxes.length', idleAjaxes.length);
        },

        url: function(newUrl) {
          console.log('CP-AJAX-MULTIPLEXER: new url:', newUrl);
          var thisId = findFreeCoreAjaxIndex();
          var coreAjax = coreAjaxes[thisId];
          var callback = makeCallback(this, thisId);

          coreAjax.addEventListener('core-response', function(e) {
            callback(e);
          });
          coreAjax.url=newUrl;

          return thisId;
        },

      }); // Polymer()
    })();

  </script>
</polymer-element>
