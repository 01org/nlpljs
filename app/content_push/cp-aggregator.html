<link rel="import" href="./cp-fetcher.html">

<polymer-element name="cp-aggregator">
  <template>
    <cp-fetcher id="fetcher" resultsPerFetch="5"></cp-fetcher>
  </template>

  <script>
    (function () {
      var logSearch = function (self) {
        self.pendingSearches--;

        /* if there are no pending searches, fire event */
        if (self.pendingSearches < 1) {
          console.log('CP-AGGREGATOR: no pending searches');
          self.fire('nopendingsearches');
        }
      };

      var getResultsFromSource = function (self, searchTerm, service, sourceURL) {
        self.$.fetcher.fetch(searchTerm, service, sourceURL).then(
          function (results) {
            logSearch(self);

            self.fire("receivedresults", {
              service: service,
              searchTerm: searchTerm,
              results: results
            });
          },

          function (err) {
            logSearch(self);

            self.fire("searchfailed", {
              service: service,
              searchTerm: searchTerm,
              error: err
            });
          }
        );
      };

      Polymer({
        created: function () {
          this.sources = {};
          this.services = [
            "Google Image Search",
            "Google Article Search",
            "Google Drive Search"
          ];

          this.pendingSearches = 0;
        },

        addSource: function (type, name, url) {
          if (typeof this.sources[type] === 'undefined')
            this.sources[type] = { sources: {} };

          this.sources[type].sources[name] = {
            name: name,
            url: url,
            enabled: false
          };

          console.log("CP-AGGREGATOR: Added source: " + name + " " + url);
        },

        removeSource: function (type, name) {
          delete this.sources[type].sources[name];

          console.log("CP-AGGREGATOR: Removed source: " + name);
        },

        enableSource: function (type, name) {
          this.sources[type].sources[name].enabled = true;

          console.log("CP-AGGREGATOR: Enabled source: " + name);
        },

        disableSource: function (type, name) {
          this.sources[type].sources[name].enabled = false;

          console.log("CP-AGGREGATOR: Disabled source: " + name);
        },

        aggregate: function (searchTerms) {
          for (var i = 0; i < searchTerms.length; i++) {
            if (typeof this.sources["Images"] !== 'undefined') {
              for (var j in this.sources["Images"].sources) {
                if (this.sources["Images"].sources[j].enabled === true) {
                  this.pendingSearches++;
                  getResultsFromSource(this, searchTerms[i],
                  this.services[0], this.sources["Images"].sources[j].url);
                }
              }
            } else {
              this.pendingSearches++;
              getResultsFromSource(this, searchTerms[i], this.services[0], '');
            }

            if (typeof this.sources["Articles"] !== 'undefined') {
              for (var j in this.sources["Articles"].sources) {
                if (this.sources["Articles"].sources[j].enabled === true) {
                  this.pendingSearches++;
                  getResultsFromSource(this, searchTerms[i],
                    this.services[1], this.sources["Articles"].sources[j].url);
                }
              }
            } else {
              this.pendingSearches++;
              getResultsFromSource(this, searchTerms[i], this.services[1], '');
            }

            this.pendingSearches++;
            getResultsFromSource(this, searchTerms[i], this.services[2]);
          }
        }
      });
    })();
  </script>
</polymer-element>
