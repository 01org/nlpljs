<link rel="import" href="./cp-fetcher.html">

<polymer-element name="cp-aggregator">
  <template>
    <cp-fetcher id="fetcher" resultsPerFetch="5"></cp-fetcher>
  </template>

  <script>
    (function () {
      var logSearch = function (self) {
        self.pendingSearches--;
        console.log('CP-AGGREGATOR: searches still pending = ' + self.pendingSearches);

        /* if there are no pending searches, fire event */
        if (self.pendingSearches === 0) {
          console.log('CP-AGGREGATOR: no pending searches');
          self.fire('nopendingsearches');
        }
      };

      var getResultsFromSource = function (self, searchTerm, service, sourceURL, sourceName) {
        if (!service) {
          return;
        }

        self.$.fetcher.fetch(searchTerm, service, sourceURL).then(
          function (results) {
            logSearch(self);

            /* add source name to each result */
            for (var i = 0; i < results.length; i++) {
              results[i].sourceName = sourceName;
            }

            self.fire('receivedresults', {
              searchTerm: searchTerm,
              results: results
            });
          },

          function (err) {
            logSearch(self);

            self.fire('searchfailed', {
              searchTerm: searchTerm,
              error: err
            });
          }
        )
        .catch(function (e) {
          console.error('CP-AGGREGATOR: ERROR during fetch');
          console.error('CP-AGGREGATOR', e);
          logSearch(self);
        });
      };

      Polymer({
        created: function () {
          this.sources = {};

          this.services = {
            'Google Image Search': {
              type: 'Images'
            },
            'Google Article Search': {
              type: 'Articles'
            },
            'Google Drive Search': {
              type: 'Files'
            }
          };
          this.servicesKeys = Object.keys(this.services);

          this.pendingSearches = 0;
        },

        addSource: function (type, name, url) {
          if (typeof this.sources[type] === 'undefined')
            this.sources[type] = { sources: {} };

          this.sources[type].sources[name] = {
            name: name,
            url: url,
            enabled: false
          };

          console.log('CP-AGGREGATOR: Added source: ' + name + ' ' + url);
        },

        removeSource: function (type, name) {
          delete this.sources[type].sources[name];

          console.log('CP-AGGREGATOR: Removed source: ' + name);
        },

        enableSource: function (type, name) {
          this.sources[type].sources[name].enabled = true;

          console.log('CP-AGGREGATOR: Enabled source: ' + name);
        },

        disableSource: function (type, name) {
          this.sources[type].sources[name].enabled = false;

          console.log('CP-AGGREGATOR: Disabled source: ' + name);
        },

        applySourceChanges: function (changes, searchTerms) {
          for (var i = 0; i < changes.length; i++) {
            var sourceDetail = changes[i].detail;
            var triggerSearch = false;

            switch (changes[i].type) {
              case 'sourceadded':
                this.addSource(sourceDetail.type, sourceDetail.name,
                               sourceDetail.url);
                triggerSearch = true;
                break;
              case 'sourceremoved':
                this.removeSource(sourceDetail.type, sourceDetail.name);
                break;
              case 'sourceenabled':
                this.enableSource(sourceDetail.type, sourceDetail.name);
                triggerSearch = true;
                break;
              case 'sourcedisabled':
                this.disableSource(sourceDetail.type, sourceDetail.name);
                break;
            }
          }

          if (triggerSearch && searchTerms !== null)
            this.aggregate(searchTerms);
        },

        aggregate: function (searchTerms) {
          var searches = [];

          for (var i = 0; i < searchTerms.length; i++) {
            var thisSearchTerm = searchTerms[i];

            for (var serviceIndex = 0; serviceIndex < this.servicesKeys.length; serviceIndex++) {
              var thisService = this.servicesKeys[serviceIndex];
              var sourceType = this.services[thisService].type;

              switch (thisService) {
                case 'Google Image Search':
                case 'Wikipedia Image Search':
                case 'Google Article Search':
                  var thisSources = this.sources[sourceType];
                  if (typeof thisSources !== 'undefined' &&
                      Object.keys(thisSources).length > 0) {
                    for (var j in thisSources.sources) {
                      var thisSource = thisSources.sources[j];
                      if (thisSource.enabled) {
                        searches.push([
                          this,
                          thisSearchTerm,
                          thisService,
                          thisSource.url,
                          thisSource.name
                        ]);
                      }
                    }
                  } else {
                    searches.push([this, thisSearchTerm, thisService]);
                  }
                  break;

                case 'Google Drive Search':
                  searches.push([this, thisSearchTerm, thisService]);
                  break;

                default:
                  console.warn('Unknown service:', thisService);
                  break;
              }
            }
          }

          this.pendingSearches += searches.length;

          for (var j = 0; j < searches.length; j++) {
            getResultsFromSource.apply(this, searches[j]);
          }
        }
      });
    })();
  </script>
</polymer-element>
