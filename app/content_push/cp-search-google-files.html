<!--
  search users files on Google Drive
-->
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel='import' href='../bower_components/core-ajax/core-ajax.html'>
<link rel="import" href="./cp-auth.html">
<link rel="import" href="./cp-globals.html">

<polymer-element name="cp-search-google-files" attributes="resultsPerFetch">
  <template>
    <cp-auth id="authorizer"></cp-auth>
    <cp-globals id="globals"></cp-globals>

    <core-ajax
      id="drive"
      auto
      handleAs="json">
    </core-ajax>
  </template>
  <script>
    (function () {

      var onCoreResponse = function (self, query, url, e, handler, callback) {
        var response = e.detail.response;

        if (response.error) {
          callback(response.error.message);
        } else {
          // accumulate the response items as results
          for (var i=0; i<response.items.length; i++) {
            var thisItem = response.items[i];

            if (thisItem.id !== self.$.globals.documentId) {
              self.results[query].push({
                type: 'file',
                service: 'Drive',
                caption: thisItem.title,
                source: thisItem.alternateLink,
                iconLink: thisItem.iconLink,
                src: thisItem.thumbnailLink,
                thumbnailSrc: thisItem.thumbnailLink,
                createdDate: thisItem.createdDate
              });
            } else {
              console.log('CP-SEARCH-GOOGLE-FILES: ignoring this file');
            }
          }

          var nextPageToken = response.nextPageToken;
          if (nextPageToken) {
            // get the next page
            self.$.drive.url = url+'&pageToken='+nextPageToken;

            self.$.drive.go();
          } else {
            self.$.drive.removeEventListener('core-response', handler);

            var numResults = self.results[query].length;
            var to  = Math.min(numResults, self.cursor[query] + self.resultsPerFetch);
            var resultsToReturn = self.results[query].slice(0, to);
            self.cursor[query] += to;

            callback(resultsToReturn);
          }
        }
      };

      /**
       * make an event handler for the core ajax response
       *
       * adds in handler to the parameter list so that it can
       * be removed when the query ends
       **/
      var makeEventHandler = function(self, query, url, callback) {
        var handler = function(e) {
          onCoreResponse(self, query, url, e, handler, callback);
        };

        return handler;
      };

      /**
       * Retrieve a list of File resources.
       *
       * @param {Function} callback Function to call when the request is complete.
       */
      var retrieveAllFiles = function (self, query, callback) {

        var q = encodeURIComponent("fullText contains '" + query + "' and trashed = false");

        self.$.drive.url =
          'https://www.googleapis.com/drive/v2/files?'+
            'access_token='+self.access_token+'&'+
            'q='+q;

        var thisEventHandler = makeEventHandler(self, query, self.$.drive.url, callback);
        self.$.drive.addEventListener('core-response', thisEventHandler);

        self.$.drive.go();
      };

      /**
       * searches user's files for files containing 'query', adds  them in resultSet.
       * returns a promise that is resolved when finished searching.
       */
      function searchForFiles (self, query) {
        self.results[query] = [];
        self.cursor[query] = 0;

        var promise = new Promise(function (resolve, reject) {
          retrieveAllFiles(self, query, function(results) {
            if (results.error) {
              reject(results.error);
            } else {
              resolve(results);
            }
          });
        });

        return promise;
      }

      Polymer({
        created: function () {
          this.access_token = null;
          this.ready_promise = null;
          this.results = {}; // this.results[query]=[...results...]
          this.cursor = {};  // this.cursor[query]=0..length-1
        },

        ready: function () {
          var self=this;
          this.ready_promise = new Promise(function (resolve, reject) {
            self.$.authorizer.addEventListener('accesstoken', function (e) {
              if (e.detail.service === 'google') {
                self.access_token=e.detail.token;
                resolve();
              }
            });
            self.$.authorizer.getToken('google');
          });
        },

        fetch: function (query) {
          if (this.results[query]) {
            var resultsToReturn = [];
            var numResults = this.results[query].length;
            if (this.cursor[query] < numResults) {
              var from = this.cursor[query];
              var to   = Math.min(numResults, this.cursor[query] + this.resultsPerFetch);
              resultsToReturn = this.results[query].slice(from, to);
              this.cursor[query] += (to-from);
            }
            return Promise.resolve(resultsToReturn);
          } else {
            var self = this;

            return this.ready_promise.then(
              function () {
                return searchForFiles(self, query);
              },
              function (error) {
                return Promise.reject(error);
              }
            );
          }
        },

      });
    })();
  </script>
</polymer-element>
