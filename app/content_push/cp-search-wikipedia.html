<!--
element to return Wikipedia image search data via JSONP;
uses the wikimedia search API: http://www.mediawiki.org/wiki/API:Search
-->
<link rel="import" href="./cp-search.html">

<polymer-element name="cp-search-wikipedia" extends="cp-search"
                 attributes="searchType">
  <script src="jsonp.js"></script>
  <script src="cp-thumbnailer.js"></script>

  <script>
    (function () {
      /* hard limit on search page size set by Wikipedia */
      var MAX_RESULTS_PER_SEARCH = 50;

      /* format Wikipedia date in format "YYYY:MM:DD"
         to "YYYY-MM-DD" */
      var DATE_REGEX = /^(\d{4}:\d{2}:\d{2})(.*)$/;

      var formatDate = function (datetime) {
        var dateMatch = datetime.match(DATE_REGEX);
        if (dateMatch) {
          datetime = dateMatch[1].replace(/:/g, '-') + dateMatch[2];
        }
        return datetime;
      };

      /* declare the element */
      Polymer({
        /* type of search: 'image' or 'article' */
        searchType: 'image',

        created: function () {
          this.super();
        },

        /* returns a single image object to be added to a result set;
           this is wrapped in a Promise as the article results have
           to be returned asynchronously */
        parseImageResult: function (result) {
          var data = result.imageinfo[0];
          var meta = data.extmetadata;
          var thumbnailSrc = Thumbnailer.getGoogleURL(data.url);

          return Promise.resolve({
            src: data.url,
            thumbnailSrc: thumbnailSrc,
            width: data.width,
            height: data.height,
            type: 'image',
            caption: (meta.ObjectName ? meta.ObjectName.value : ''),
            source: data.descriptionurl,
            meta: {
              ExifVersion: (meta.ExifVersion ?
                                meta.ExifVersion.value : null),
              DateTime: (meta.DateTime ?
                            formatDate(meta.DateTime.value) : null),
              Camera: (meta.Model ? meta.Model.value.trim() : null)
            }
          });
        },

        parseArticleResult: function (result) {
          var src = 'https://images1-focus-opensocial.googleusercontent.com/gadgets/proxy?container=focus&refresh=3600&resize_w=600&url=https%3A%2F%2Fupload.wikimedia.org%2Fwikipedia%2Fcommons%2Ff%2Ff2%2FBattle_of_Hastings-battleplan.png';
          var thumbnailSrc = 'https://images1-focus-opensocial.googleusercontent.com/gadgets/proxy?container=focus&refresh=3600&resize_w=600&url=https%3A%2F%2Fupload.wikimedia.org%2Fwikipedia%2Fcommons%2Ff%2Ff2%2FBattle_of_Hastings-battleplan.png';

          return Promise.resolve({
            caption: result.title,
            src: src,
            thumbnailSrc: thumbnailSrc,
            type: 'article',
            source: 'http://wikipedia.org/wiki/' + result.title,
            snippet: 'foo'
          });
        },

        /* get the base URL to use for an image search */
        getImageSearchUrl: function () {
          return 'https://commons.wikimedia.org/w/api.php?action=query' +
                 '&generator=search' +
                 '&gsrnamespace=6' +
                 '&prop=imageinfo' +
                 '&iiprop=extmetadata|url|size';
        },

        /* get the base URL to use for an article search; rvparse causes
           the content to be rendered to HTML before it is returned */
        getArticleSearchUrl: function () {
          return 'https://commons.wikimedia.org/w/api.php?action=query' +
                 '&generator=search' +
                 '&gsrnamespace=0' +
                 '&prop=revisions' +
                 '&rvprop=content' +
                 '&rvparse';
        },

        /* prepare results for query; returns a promise which resolves
           to a ResultSet for the query */
        searchImpl: function (resultSet, query) {
          var self = this;

          var url;
          if (this.searchType === 'image') {
            url = this.getImageSearchUrl(resultSet, query);
          } else {
            url = this.getArticleSearchUrl(resultSet, query);
          }

          /* add common parameters to the search URL */
          url += '&gsrsearch=%22' + encodeURIComponent(query) + '%22' +
                 '&gsrlimit=' + MAX_RESULTS_PER_SEARCH +
                 '&gsroffset=' + resultSet.offset +
                 '&format=json' +
                 '&rawcontinue';

          console.log('CP-SEARCH-WIKIPEDIA: search ' + this.searchType +
                      ' URL = ' + url);

          return new Promise(function (resolve, reject) {
            jsonp({
              url: url,
              cb: function (response) {
                self.handleResponse(resultSet, query, response)
                .catch(
                  function (e) {
                    console.error('CP-SEARCH-WIKIPEDIA ERROR: ' + e.message);
                    reject(e);
                  }
                )
                .then(
                  resolve, reject
                );
              }
            });
          });
        },

        /* returns the resultSet, populated with the images from
           response */
        handleResponse: function (resultSet, query, response) {
          if (response.error) {
            var err = new Error('CP-SEARCH-WIKIPEDIA: ' +
                                'ERROR from Wikipedia API: ' +
                                JSON.stringify(response));
            return Promise.reject(err);
          }

          if (response['query-continue'] && response['query-continue'].search) {
            // offset for the next search for this query (according to Wikipedia)
            var offset = response['query-continue']['search'].gsroffset;

            /* NB another search may have already reset the offset
               on the ResultSet, so use the biggest value */
            resultSet.setOffset(Math.max(offset, resultSet.offset));
          } else {
            // end of result set reached
            resultSet.setExhausted();
          }

          // results for this search
          if (!(response.query && response.query.pages)) {
            var err = new Error('CP-SEARCH-WIKIPEDIA: ERROR - ' +
                                'no "query" property in response: ' +
                                JSON.stringify(response));
            return Promise.reject(err);
          }

          var pages = response.query.pages;

          var parsePromises = [];

          for (var k in pages) {
            if (pages.hasOwnProperty(k)) {
              if (this.searchType === 'image') {
                parsePromises.push(this.parseImageResult(pages[k]));
              } else {
                parsePromises.push(this.parseArticleResult(pages[k]));
              }
            }
          }

          return Promise.all(parsePromises).then(function (results) {
            for (var i = 0; i < results.length; i++) {
              resultSet.add(results[i]);
            }

            return Promise.resolve(resultSet);
          });
        }
      });
    })();
  </script>
</polymer-element>
