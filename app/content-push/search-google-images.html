<link rel="import" href="../bower_components/core-ajax/core-ajax.html">

<polymer-element name="search-google-images" attributes="query">
  <template>
    <core-ajax
      id="core_ajax"
      auto="false"
      url="https://www.googleapis.com/customsearch/v1?searchType=image&key={{key}}&cx={{cx}}&q={{query}}&rights={{rights}}"
      handleAs="json"
      on-core-response="{{handleResponse}}">
    </core-ajax>
  </template>
  <script>
    Polymer({
      // TODO put in config; these are townxelliot's personal
      // API key and custom search engine
      key: "AIzaSyALRtaOgPBIkxDeCr10JBnCtrIo3uahgmg",
      cx: "009009366889943162389:qxyeiz__u68",

      // only one type of licence can be specified at a time
      // (I discovered this through trial and error)...
      rights: "cc_publicdomain",

      // setting this property triggers a new search
      query: "",

      queryChanged: function () {
        this.$.core_ajax.go();
      },

      // fires a 'searchResults' event when a search returns;
      // the data for that event is an array of image objects:
      // [{url: <img src url>}, ...]
      handleResponse: function (e) {
        var imgs = [];

        var response = e.detail.response;

        if (response.error) {
          console.error("CP:error from Google images:", response.error.message);
        }
        else {
          var img;
          for (var i = 0; i < response.items.length; i++) {
            imgs.push({url: response.items[i].link});
          }
        }

        this.fire("searchResults", imgs);
      }
    });
  </script>
</polymer-element>
