<!--
search users files on Google Drive
-->
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/google-apis/google-apis.html">
<link rel="import" href="./cp-globals.html">
<link rel="import" href="./cp-auth.html">
<link rel="import" href="./cp-search.html">
<polymer-element name="cp-search-google-files" extends="cp-search">
  <template>
    <cp-auth id="authorizer"></cp-auth>
    <cp-globals id="globals"></cp-globals>

    <google-api-loader
      id="drive"
      name="drive"
      version="v2"
      on-google-api-load="{{onDriveLoad}}"
      on-google-api-load-error="{{onDriveLoadError}}">
    </google-api-loader>
  </template>
  <script>
    (function () {
      var MAXRESULTS = 10;

      /**
       * Retrieve a list of File resources.
       *
       * @param {Function} callback Function to call when the request is complete.
       */
      var retrieveAllFiles = function (self,query,callback) {

        var q=[
            'fullText', 'contains', '\''+query+'\'',
            'and',
            'trashed', '=', 'false'
          ].join(' ');

        console.log('CP-SEARCH-GOOGLE-FILES:query:',query);
        console.log('CP-SEARCH-GOOGLE-FILES:q:',q);

        var retrievePageOfFiles = function (request, result) {

          request.execute( function(response) {
            result = result.concat(response.items);

            var nextPageToken = response.nextPageToken;
            if (nextPageToken) {
              request = gapi.client.drive.files.list({
                pageToken: nextPageToken,
                q: q
              });

              retrievePageOfFiles(request, result);
            } else {
              callback(result);
            }
          });
        }

        var initialRequest = self.$.drive.api.files.list({q:q});

        retrievePageOfFiles(initialRequest, []);
      };

      function handleResponse (self,resultSet,query) {
        var promise = new Promise( function(resolve,reject) {

          retrieveAllFiles(self,query,function (results) {
            for (var i=0,
                     noResults=Math.min(results.length,MAXRESULTS);
                 i<noResults;
                 i++) {
              var thisResult=results[i];
              console.log('CP-AUTH:RESULT:',i,thisResult);

              resultSet.add({
                  //type: 'file',
                  type: 'image',
                  title: thisResult.title,
                  iconLink: thisResult.iconLink,
                  src: thisResult.thumbnailLink,
                  thumbnailSrc: thisResult.thumbnailLink,
                  width: 500, // HACK
                  height: 500, // HACK
                  keyword: query, // HACK
              });
            }

            resolve(resultSet);
          });
        });

        return promise;
      }

      Polymer({
        created: function () {
          this.super();
        },

        ready: function () {
          //this.app_id = this.$.globals.data.app_id;
        },

        /* prepare results for query; returns a promise which resolves
           to a ResultSet for the query */
        searchImpl: function (resultSet, query) {
          var self = this;

          return new Promise(function (resolve, reject) {

            /* Google image results count from 1, whereas resultSet
               offsets start from 0 */
            var start = resultSet.offset + 1;

            // get ready for incoming auth token
            self.$.authorizer.addEventListener('accesstoken',function(e) {
              if (e.detail.service==='google') {
                gapi.auth.setToken({access_token:e.detail.token});

                // perform query
                handleResponse(self,resultSet,query).then(resolve,reject);

                // we've got the token, so remove the listener
                self.$.authorizer.removeEventListener(this);
              }

            });

            // get the auth token
            self.$.authorizer.getToken('google');
          });
        },

        onDriveLoad: function() {
          console.log('CP-SEARCH-GOOGLE-FILES: drive api loaded');
        },

        onDriveLoadError: function() {
          console.error('CP-SEARCH-GOOGLE-FILES: failed to load drive api');
        },

      });
    })();
  </script>
</polymer-element>
