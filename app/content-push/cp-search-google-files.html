<!--
search users files on Google Drive
-->
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/google-apis/google-apis.html">
<link rel="import" href="./cp-auth.html">
<link rel="import" href="./cp-search.html">
<polymer-element name="cp-search-google-files" extends="cp-search">
  <template>
    <cp-auth id="authorizer"></cp-auth>

    <google-api-loader
      id="drive"
      name="drive"
      version="v2"
      on-google-api-load-error="{{onDriveLoadError}}">
    </google-api-loader>
  </template>
  <script>
    (function () {
      var MAXRESULTS = 10;

      /**
       * Retrieve a list of File resources.
       *
       * @param {Function} callback Function to call when the request is complete.
       */
      var retrieveAllFiles = function (self,query,callback) {

        var q=[
            'fullText', 'contains', '\''+query+'\'',
            'and',
            'trashed', '=', 'false'
          ].join(' ');

        console.log('CP-SEARCH-GOOGLE-FILES:query:',query);
        console.log('CP-SEARCH-GOOGLE-FILES:q:',q);

        var retrievePageOfFiles = function (request, result) {

          request.execute( function(response) {
            if (response.error) {
              callback(response);
            } else {
              result = result.concat(response.items);

              var nextPageToken = response.nextPageToken;
              if (nextPageToken) {
                request = gapi.client.drive.files.list({
                  pageToken: nextPageToken,
                  q: q
                });

                retrievePageOfFiles(request, result);
              } else {
                callback(result);
              }
            }
          });
        };

        var initialRequest = self.$.drive.api.files.list({q:q});

        retrievePageOfFiles(initialRequest, []);
      };

      function handleResponse (self,resultSet,query) {
        var promise = new Promise( function(resolve,reject) {

          retrieveAllFiles(self,query,function (response) {
            if (response.error) {
              console.log('CP-SEARCH-GOOGLE-FILES:error:',response.error.message);
              reject('CP-SEARCH-GOOGLE-FILES: '+response.error.message);
            } else {
              var results=response;

              console.log('CP-SEARCH-GOOGLE-FILES:results.length:',results.length);
              for (var i=0,
                       noResults=Math.min(results.length,MAXRESULTS);
                   i<noResults;
                   i++) {
                var thisResult=results[i];
                console.log('CP-SEARCH-GOOGLE-FILES:RESULT:',i,thisResult);

                resultSet.add({
                    type: 'file',
                    title: thisResult.title,
                    iconLink: thisResult.iconLink,
                    src: thisResult.thumbnailLink,
                    thumbnailSrc: thisResult.thumbnailLink,
                    width: 500, // HACK
                    height: 500, // HACK
                    keyword: query, // HACK
                });
              }

              resolve(resultSet);
            }
          });
        });

        return promise;
      }

      Polymer({
        created: function () {
          this.super();
          this.access_token=null;
          this.access_token_promise=null;
          this.ready_promise=null;
        },

        ready: function () {
          var self=this;
          this.ready_promise = new Promise(function(resolve,reject) {
            self.$.authorizer.addEventListener('accesstoken',function(e) {
              if (e.detail.service==='google') {
                console.log('CP-SEARCH-GOOGLE-FILES: received token');
                self.access_token=e.detail.token;
                resolve();
              }
            });
            self.$.authorizer.getToken('google');
          }).then(new Promise(function(resolve,reject) {
            self.$.drive.addEventListener('google-api-load',function(e) {
              console.log('CP-SEARCH-GOOGLE-FILES: drive api loaded:',e);
              console.log('CP-SEARCH-GOOGLE-FILES: setting token in gapi.auth');
              gapi.auth.setToken({access_token:self.access_token});
              resolve();
            });
          }));
        },

        /* prepare results for query; returns a promise which resolves
           to a ResultSet for the query */
        searchImpl: function (resultSet, query) {
          var self = this;

          return this.ready_promise.then(function (resolve,reject) {
              handleResponse(self,resultSet,query).then(resolve,reject);
          });
        },

        onDriveLoadError: function() {
          console.error('CP-SEARCH-GOOGLE-FILES: failed to load drive api');
        },

      });
    })();
  </script>
</polymer-element>
