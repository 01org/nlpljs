<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-splitter/core-splitter.html">
<link rel="import" href="../bower_components/core-component-page/core-component-page.html">
<polymer-element name="content-push" attributes="iframeurl toggle">
  <template>
    <style>
      :host {
        display: block;
        width: 100%;
        height: 100%;
        background-color: #F0F0F0;
      }

      #container {
        height: 100%;
      }
      #splitter {
        background-color: #202020;
        box-shadow:none;
        width:8px;
      }
      #iframe {
        display: block;
        background-color: #F0F0F0;
        height: 100%;
        float:left;
      }

      #content_push_panel {
        display: block;
        background-color: #F0F0F0;
        height: 100%;
        width:300px;
        max-width: 25%;
        min-width:300px;
        float:right;
      }
      #panel{
        height:100%;
        margin:0;
        padding:0;
      }
      #toolbar{
        display: block;
        background-color: #202020;
        margin:0;
        padding:0;
      }
      #toolbartext {
        color: #FFFFFF;
        -webkit-user-select: none;
      }
      #toolbaraction {
        color: #FFFFFF;
        -webkit-user-select: none;
      }
      #menutoolbar{
        background-color: #F0F0F0;
        margin:0;
        padding:0;
      }
      img {
        max-width: 50%;
        height: auto;
      }
    </style>
    <!--This is the main container. It contains the iframe which loads the target url, a splitter and Content Push Panel-->
    <div id="container" horizontal layout>
      <!--This is iframe for the target URL-->
      <iframe id="iframe" flex></iframe>
      <!--Splitter-->
      <core-splitter id="splitter" direction="right" on-down="{{downAction}}" on-up="{{upAction}}"></core-splitter>
      <!--Content Push Panel-->
      <div id="content_push_panel">
        <!--the panel is made up of a header toolbar, a content toolbar and the content-->
        <core-toolbar id="toolbar">
          <div id="toolbartext" flex>Content Push</div>
          <core-icon-button id="toolbaraction" icon="close" on-tap="{{closePanel}}"></core-icon-button>
        </core-toolbar>
        <!--content toolbar and content wrapped up in a core-header-panel-->
        <core-header-panel id="panel">
        <core-toolbar id="menutoolbar">
          <!--TODO:USe paper-icon-button, add paper-ripple effect and styling-->
          <paper-tabs>
          <paper-tab>
            <core-icon-button icon="drive"></core-icon-button></paper-tab>
          <paper-tab>
            <core-icon-button icon="drive-image"></core-icon-button></paper-tab>
          </paper-tabs>
        </core-toolbar>
        <div id="content">
          <!--Content based on the tab selection-->
        </div>
          <!--<div id="content_from_iframe"></div>-->
          <!--<core-xhr id="google_images"></core-xhr>-->
          <!--<div id="images"></div>-->
        </core-header-panel>
      </div>
  
    </div>
  </template>
  <script>
    Polymer({
      open:true,
      created: function() {
        this.iframeurl="";

        // from https://console.developers.google.com/project
        this.googleImages_key = 'AIzaSyALRtaOgPBIkxDeCr10JBnCtrIo3uahgmg';

        // from https://www.google.com/cse/manage/all
        this.googleImages_cseId = '009009366889943162389:qxyeiz__u68';

        this.googleImages_baseUrl = 'https://www.googleapis.com/customsearch/v1';
      },

      iframeurlChanged: function(oldValue,newValue) {
        //console.log("CP:new iframeurl:",newValue);
        self.$.iframe.src=newValue;
      },
      
      toggleChanged: function(oldValue,newValue) {
        this.togglePanel();
      },

      ready: function() {
        self=this;
        //console.log("CP:iframeurl:",self.iframeurl);
        self.$.iframe.src=self.iframeurl;

        self.$.iframe.onload=function() {
          //console.log("CP:iframe onload");
          // demonstrate stuff can be copied from the iframe document
          var totalLinesToAdd=5;
          var textToAdd = "";
          var lines=self.$.iframe.contentDocument.querySelectorAll(".kix-lineview");
          for( var i=0; i<totalLinesToAdd; ++i) {
            var text=lines[i].innerText;
            textToAdd+=text;
          }

          self.$.content_from_iframe.innerText=textToAdd;
        };

        this.search();
      },

      search: function (query) {
        // TODO pass this to the function rather than hard-coding
        query = 'intel';

        var handler = this.handleGoogleImagesResponse.bind(this);

        var searchParams = {
          searchType: 'image',
          key: this.googleImages_key,
          cx: this.googleImages_cseId,
          q: query
        };

        this.$.google_images.request({
          url: this.googleImages_baseUrl,
          params: searchParams,
          responseType: 'json',
          callback: handler
        });
      },

      handleGoogleImagesResponse: function (response) {
        if (response.error) {
          //console.log("CP:error from Google:",response.error.message);
        } else {
          var img;
          for (var i = 0; i < response.items.length; i++) {
            img = document.createElement('img');
            img.src = response.items[i].link;
            this.$.images.appendChild(img);
          }
        }

      },

      downAction: function() {
        this.$.iframe.style.pointerEvents = 'none';
      },
      upAction: function() {
        this.$.iframe.style.pointerEvents = '';
      },
      closePanel: function() {
        this.$.content_push_panel.style.display = 'none';
        this.open = false;
      },
      togglePanel: function() {
        if (this.open) {
          this.$.content_push_panel.style.display = 'none';
          this.open = false;
        } else {
          this.$.content_push_panel.style.display = 'inline-block';
          this.open = true;
        }
      }
    });
  </script>
</polymer-element>
