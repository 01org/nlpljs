<link rel="import" href="../bower_components/core-splitter/core-splitter.html">
<link rel="import" href="../bower_components/core-toolbar/core-toolbar.html">
<link rel="import" href="../bower_components/core-icon-button/core-icon-button.html">
<link rel="import" href="../bower_components/core-header-panel/core-header-panel.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="./search-google-images.html">

<polymer-element name="content-push" attributes="iframeurl toggle">
  <template>
    <style>
      :host {
        display: block;
        width: 100%;
        height: 100%;
        background-color: #F0F0F0;
      }

      #container {
        height: 100%;
      }

      #splitter {
        background-color: #202020;
        box-shadow:none;
        width:8px;
      }

      #iframe {
        display: block;
        background-color: #F0F0F0;
        height: 100%;
        float:left;
      }

      #content_push_panel {
        display: block;
        background-color: #F0F0F0;
        height: 100%;
        width:300px;
        max-width: 25%;
        min-width:300px;
        float:right;
      }

      #panel {
        height:100%;
        margin:0;
        padding:0;
      }

      #toolbar {
        display: block;
        background-color: #202020;
        margin:0;
        padding:0;
      }

      #toolbartext {
        color: #FFFFFF;
        -webkit-user-select: none;
      }

      #toolbaraction {
        color: #FFFFFF;
        -webkit-user-select: none;
      }

      #menutoolbar {
        background-color: #F0F0F0;
        margin:0;
        padding:0;
      }

      .current_buffer {
        background-color: red;
      }

      img {
        max-width: 50%;
        height: auto;
      }
    </style>
    <div id="container" horizontal layout>
      <iframe id="iframe" flex></iframe>
      <core-splitter id="splitter" direction="right" on-down="{{downAction}}" on-up="{{upAction}}"></core-splitter>
      <div id="content_push_panel">
        <!--the panel is made up of a header toolbar, a content toolbar and the content-->
        <core-toolbar id="toolbar">
          <div id="toolbartext" flex>Content Push</div>
          <core-icon-button id="toolbaraction" icon="close" on-tap="{{closePanel}}"></core-icon-button>
        </core-toolbar>
        <!--content toolbar and content wrapped up in a core-header-panel-->
        <core-header-panel id="panel">
          <core-toolbar id="menutoolbar">
            <!--TODO:USe paper-icon-button, add paper-ripple effect and styling-->
            <paper-tabs>
              <paper-tab>
                <core-icon-button icon="drive"></core-icon-button>
              </paper-tab>
              <paper-tab>
                <core-icon-button icon="drive-image"></core-icon-button>
              </paper-tab>
            </paper-tabs>
          </core-toolbar>
          <div id="content">
            <h4>Multiple lines on frame load</h4>
            <p id="multiple_lines"></p>
            <h3>Buffering changes</h3>
            <div id="buffer_timer">-</div>
            <h4>Buffer0</h4>
            <p id="buffer_0" class="current_buffer">(empty)</p>
            <h4>Buffer1</h4>
            <p id="buffer_1">(empty)</p>
            <h4>Sent to NLP</h4>
            <p id="nlp_buffer">(empty)</p>
            <h4>Get images for changed text</h4>
            <button id="image_button" on-click="{{getImages}}">Go!</button>
            <h4>Images</h4>
            <search-google-images id="search_google_images" query=""></search-google-images>
            <div id="images"></div>
          </div><!-- content -->
        </core-header-panel>
      </div><!-- content_push_panel -->
    </div><!-- container -->
  </template>

  <script>
    (function contentPushApp() {
      // private properties

      // find ancestor of node that has className
      // for finding the ancestor with .kix-lineview of whatever line has changed
      var findAncestor = function(node,className) {
        var retVal=null;

        var thisNode=node;
        var cssSelectorNotFound=true;

        while (cssSelectorNotFound && thisNode && thisNode.nodeName!="BODY") {
          cssSelectorNotFound=!thisNode.classList.contains(className);
          if (cssSelectorNotFound) {
            // move into parent node
            thisNode=thisNode.parentNode;
          } else {
            // finished
            retVal=thisNode;
          }
        }

        return retVal;
      };

      // NOTE: doesn't handle removed lines
      var observeDocumentChanges = function(iframe,callBack) {
        var docsContainerSelector = ".kix-paginateddocumentplugin";
        var docsFilterSelector = ".kix-lineview";

        // Create an observer instance
        var observer = new MutationObserver(function(mutations,observerInstance) {
          mutations.forEach(function(mutation) {
            var newNodes = mutation.addedNodes; // DOM NodeList
            if (newNodes !== null) { // If there are new nodes added
              for (var i=0;i<newNodes.length;++i) {
                var thisNode=newNodes[i];
                if (thisNode) {
                  var lineview=(thisNode.classList.contains("kix-lineview"))?thisNode:findAncestor(thisNode,"kix-lineview");
                  if (lineview) {
                    callBack(lineview.textContent);
                  }
                }
              }
            }
          });
        });

        // Configuration of the observer:
        var config = {
          attributes: true,
          childList: true,
          subtree: true,
          characterData: true
        };

        // Pass in the target node, as well as the observer options
        var node=iframe.contentDocument.querySelector(docsContainerSelector);
        observer.observe(node, config);
      };

      Polymer({
        open:true,

        created: function() {
          this.iframeurl="";
        },

        iframeurlChanged: function(oldValue,newValue) {
          self.$.iframe.src=newValue;
        },

        toggleChanged: function(oldValue,newValue) {
          this.togglePanel();
        },

        ready: function() {
          self=this;
          self.$.iframe.src=self.iframeurl;

          self.$.iframe.onload=function() {
            // demonstrate stuff can be copied from the iframe document
            var totalLinesToAdd=3;
            var textToAdd = "";
            var lines=self.$.iframe.contentDocument.querySelectorAll(".kix-lineview");
            for( var i=0; i<totalLinesToAdd; ++i) {
              var text=lines[i].innerText;
              textToAdd+=text;
            }

            var textNode=document.createTextNode(textToAdd.replace("&nbsp;"," "));
            self.$.multiple_lines.appendChild(textNode);

            var bufferElement=[
              self.$.buffer_0,
              self.$.buffer_1
            ];
            var changeBuffer0=[];
            var changeBuffer1=[];
            var changeBuffer=[ changeBuffer0, changeBuffer1 ];
            var currentBuffer=0;
            var timerValue=5;
            observeDocumentChanges(self.$.iframe, function(text) {
              if (changeBuffer[currentBuffer].length==0) {
                // empty element - notably '(empty)' string
                bufferElement[currentBuffer].innerHTML="";

                // swapBuffers after 5 seconds
                setTimeout(swapBuffers,5000);

                // start buffer_timer countdown
                timerValue=5;
                self.$.buffer_timer.innerText=timerValue;
                var intervalId;
                function decTimer() {
                  timerValue--;
                  self.$.buffer_timer.innerText=timerValue+"";
                  if (timerValue==0) {
                    self.$.buffer_timer.innerText="-";
                    clearInterval(intervalId);
                  }
                };
                intervalId=setInterval(decTimer,1000);
              }

              // push new line to buffer
              changeBuffer[currentBuffer].push(text);

              // add new line to buffer element
              var textNode=document.createTextNode(text.replace("&nbsp;"," "));
              bufferElement[currentBuffer].appendChild(textNode);
            });

            function swapBuffers() {
              // copy current buffer to nlp buffer
              self.$.nlp_buffer.innerText=bufferElement[currentBuffer].innerText;

              // empty current buffer
              changeBuffer[currentBuffer]=[];
              bufferElement[currentBuffer].innerHTML="(empty)";

              // swap buffers
              bufferElement[currentBuffer].className=bufferElement[currentBuffer].className.replace(/\bcurrent_buffer\b/,'');
              currentBuffer=(currentBuffer==0)?1:0;
              bufferElement[currentBuffer].className=bufferElement[currentBuffer].className+" current_buffer";
            };
          };

          // bind event handlers to search components
          var handler = this.handleSearchResults.bind(this);
          this.$.search_google_images.addEventListener("searchResults", handler);
        },

        search: function (query) {
          this.$.search_google_images.query = query;
        },

        handleSearchResults: function (e) {
          var self = this;

          var images = e.detail;

          for (var i = 0; i < images.length; i++) {
            var img = document.createElement("img");
            img.src = images[i].url;

            // only add images to the display if they load correctly
            img.addEventListener("load", function () {
              self.$.images.appendChild(this);
            });
          }
        },

        getImages: function() {
          this.search(this.$.changed_text.innerText);
        },

        downAction: function() {
          this.$.iframe.style.pointerEvents = 'none';
        },

        upAction: function() {
          this.$.iframe.style.pointerEvents = '';
        },

        closePanel: function() {
          this.$.content_push_panel.style.display = 'none';
          this.open = false;
        },

        togglePanel: function() {
          if (this.open) {
            this.$.content_push_panel.style.display = 'none';
            this.open = false;
          } else {
            this.$.content_push_panel.style.display = 'inline-block';
            this.open = true;
          }
        }
      }); // Polymer()
    })();

  </script>
</polymer-element>
