<!--
wraps a single element in a scrollable area;
when the wrapped element is shorter than the scrollable area, a button
is shown which triggers a "morecontent" event when pressed;
if the wrapped element is the same height or taller than the scroller,
the button is hidden and a vertical scrollbar is added; then, when the
end of the scroll is reached, a "more content" event is fired (the same
as if the button were pressed)

for this to work, the infini-scroll element should have a fixed size
(e.g. set width and height to a percentage of its parent element);
and the element you are wrapping must fire a "resize" event when its
dimensions change, with this data:

  {
    width: <new width in pixels>,
    height: <new height in pixels>
  }

note that if multiple elements are inside an infini-scroll, only the
first one is used to determine whether the button is visible and
to set the y scroll boundary
-->
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">

<!-- this is needed for the icon on the "more" button -->
<link rel="import" href="../bower_components/core-icons/core-icons.html">

<polymer-element name="infini-scroll" attributes="showbutton">
  <template>
    <style>
      :host {
        display: block;
        flex-direction: column;
        overflow-x: hidden;
        overflow-y: scroll;
      }

      #more {
        text-align: center;
        margin: 3em 0 0 0;
        width: 50%;
        margin-left: 25%;
        border-top: thin solid gray;
        content-sizing: border-box;
      }

      #morebutton {
        background-color: #01bcd4;
        color: gray;
      }

      [data-show="false"] {
        display: none;
      }
    </style>

    <div id="container">
      <content id="content" select="*" on-resize="{{onContentResize}}">
      </content>
    </div>

    <div id="more" data-show="{{showbutton}}">
      <p>Widen the search</p>
      <paper-fab id="morebutton" mini icon="add-circle-outline"
                 raisedButton="true" on-click="{{fireMoreContent}}">
      </paper-fab>
    </div>
  </template>

  <script>
    Polymer({
      domReady: function () {
        /*
        set to false if the button should be hidden; this is automatically
        set to false once the height of the #content element is equal
        to or greater than the height of the infini-scroll
        */
        this.showbutton = true;

        // event handler for scroll events on the container
        this.addEventListener('scroll', this.onScroll.bind(this));
      },

      /*
        if the height of the content item + height of the "more"
        container is >= the height of the infini-scroll, hide the
        button
      */
      onContentResize: function (e) {
        var contentHeight = e.detail.height;
        var moreHeight = this.$.more.offsetHeight;
        var thisHeight = this.offsetHeight;
        if (this.showbutton && contentHeight + moreHeight > thisHeight) {
          this.showbutton = false;
          this.fireMoreContent();
        }
      },

      onScroll: function () {
        if (this.scrollTop + this.offsetHeight >= this.scrollHeight - 100) {
          this.fireMoreContent();
        }
      },

      /*
      fire a "morecontent" event, signifying either that the "more" button
      was pressed, or that the end of the scroll was reached; it's up
      to listeners to decide what to do with this (e.g. append more
      content into the wrapped element)
      */
      fireMoreContent: function () {
        this.fire('morecontent');
      }
    });
  </script>
</polymer-element>
