<link rel="import" href="../bower_components/core-toolbar/core-toolbar.html">
<link rel="import" href="../bower_components/core-icon-button/core-icon-button.html">
<link rel="import" href="../bower_components/core-icon/core-icon.html">
<link rel="import" href="../bower_components/core-header-panel/core-header-panel.html">
<link rel="import" href="../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/core-icons/core-icons.html">
<link rel="import" href="../bower_components/core-icons/av-icons.html">
<link rel="import" href="../bower_components/core-icons/editor-icons.html">
<link rel="import" href="./cp-fetcher.html">
<link rel="import" href="./cp-display.html">
<link rel="import" href="./cp-image-detail.html">
<link rel="import" href="./cp-swapper.html">

<polymer-element name='cp-panel' on-newkeywordinfo='{{onNewKeywordInfo}}'>
  <template>
    <style>
      :host {
        height: 100%;
      }

      #toolbar {
        display: block;
        background-color: #202020;
        margin: 0;
        padding: 0;
        z-index: 2000;
      }

      #toolbartext {
        color: #FFFFFF;
        -webkit-user-select: none;
      }

      #toolbaraction {
        color: #FFFFFF;
        -webkit-user-select: none;
      }

      #display {
        margin: 3px;
        padding: 0;
        height: 90%;
        width: 100%;
        overflow: hidden;
        box-sizing: border-box;
      }

      #slider {
        height: 100%;
      }

      core-toolbar paper-tabs {
        box-shadow: none;
      }

      cp-swapper {
        width: 100%;
        height: 100%;
      }

      cp-image-detail {
        background-color: white;
      }

      #tabs::shadow #selectionBar {
        background-color: #4CA8B4;
      }

      #menu::shadow core-icon {
        color: white;
      }
    </style>

    <!-- the panel is made up of a header toolbar and the display -->
    <core-toolbar id="toolbar">
      <paper-menu-button id="menu" icon="menu" on-click="{{applyTypeFilter}}">
        <paper-item icon="drive-image" label="Images"
                    data-type-filter="image"></paper-item>
        <paper-item icon="editor:format-color-text" label="Quotations"
                    data-type-filter="quotation"></paper-item>
        <paper-item icon="drive-file" label="Files"
                    data-type-filter="file"></paper-item>
        <paper-item icon="av:movie" label="Videos"
                    data-type-filter="video"></paper-item>
        <paper-item icon="folder" label="Quotations+Images"
                    data-type-filter="quotation,image"></paper-item>
        <paper-item icon="apps" label="All"
                    data-type-filter="no-filter"></paper-item>
      </paper-menu-button>

      <paper-item id="toolbartext" icon="" label="Content Push" flex></paper-item>

      <core-icon-button id="toolbaraction" icon="close" on-tap="{{closePanel}}"></core-icon-button>
    </core-toolbar>

    <cp-swapper id="swapper">
      <cp-display id="display"
                  on-moreresults="{{onDisplayMoreResults}}"
                  on-mouse-over="{{onDisplayMouseover}}"
                  on-mouse-out="{{onDisplayMouseout}}"
                  on-mouse-down="{{showDetail}}"
                  swapper-fix>
      </cp-display>

      <cp-image-detail id="detail" on-back="{{closeDetail}}"
                       swapper-slide swap-id="detail">
      </cp-image-detail>
    </cp-swapper>

    <cp-fetcher id="fetcher" resultsPerFetch="5"></cp-fetcher>
  </template>

  <script>
    (function cpPanel () {
      // private *static* functions and constants

      /* perform search for current keyphrase and add to the display */
      var search = function (self) {
        if (!self.keywordInfo) {
          return;
        }

        self.$.display.showLoadingSpinner();

        self.$.fetcher.fetch(self.keywordInfo).then(
          function (results) {
            self.$.display.receiveResults(results);

            /* set filter on the display based on current keywordInfo */
            self.$.display.setFilter({keywordInfo: self.keywordInfo});
          }
        );
      };

      /* test whether the keywordInfo has changed; currently this
         just compares the first keyword text in the new
         keywordInfo with the first keyword text in the panel's
         keywordInfo */
      var checkKeywordInfoChanged = function (oldKeywordInfo, newKeywordInfo) {
        /* no keyword set yet, so definitely a change */
        if (!oldKeywordInfo) {
          return true;
        }

        var oldBestKeyword = oldKeywordInfo.keywords[0].text;
        var newBestKeyword = newKeywordInfo.keywords[0].text;
        return oldBestKeyword !== newBestKeyword;
      };

      Polymer({
        // functions and properties used in API and bindings
        created: function () {
          this.keywordInfo = null;
        },

        // called from content-push.html:trackAction() when splitter moves
        layout: function () {
          this.$.display.layout();
        },

        showDetail: function (e) {
          this.$.detail.showTile(e.detail);
          this.$.swapper.slideIn('detail');
        },

        closeDetail: function () {
          this.$.swapper.slideOut('detail');
        },

        applyTypeFilter: function (e) {
          var typeFilter = e.toElement.getAttribute('data-type-filter');
          if (typeFilter) {
            console.log('type filter to apply: ' + typeFilter);
          }
        },

        /* keywordInfo event occurred on the document */
        onNewKeywordInfo: function (e) {
          console.log('PA:onNewKeywordInfo', e.detail.keywordInfo);

          /* if we have a new best keyword, run a fresh search */
          if (checkKeywordInfoChanged(this.keywordInfo, e.detail.keywordInfo)) {
            this.keywordInfo = e.detail.keywordInfo;

            /* reset scroll position, as we'll be showing new results */
            this.$.display.scrollToTop();

            search(this);
          }
        },

        /* search more using current keywordInfo */
        onDisplayMoreResults: function () {
          search(this);
        },

        onDisplayMouseover: function (e) {
          this.fire('mouseoverimage', {groupId: e.detail.groupId});
        },

        onDisplayMouseout: function (e) {
          this.fire('mouseoutimage', {groupId: e.detail.groupId});
        },

        closePanel: function () {
          this.fire('close-panel');
        }
      }); // Polymer()
    })();
  </script>
</polymer-element>
