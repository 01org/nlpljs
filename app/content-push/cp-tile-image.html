<!--
wrapper for a single img element plus related elements for
metadata; metadata elements are revealed by user interaction
(mouse hover);
the smallest image which will display OK is about 50x50px; any smaller
than this and there's not enough room for the metadata about the image
size
-->
<polymer-element name="cp-tile-image" attributes="src revealmeta loaded done">
  <template>
    <style>
      :host {
        display: inline-block;
        -webkit-animation: fadein 2s;
      }

      #container {
        display: inline-block;
        position: relative;
        overflow: hidden;
        height: 100%;
        width: 100%;
        box-sizing: border-box;
        padding: 3px 3px 3px 3px;
      }

      #container:hover {
        background-color: #01bcd4;
      }

      [data-revealed="true"] {
        display: block;
        position: absolute;
        bottom: 0;
        margin-bottom: 3px;
        background-color: black;
        color: white;
        min-width: 3em;
        text-align: center;
        padding: 0.5em;
      }

      /* adjust padding on the meta text when the image is < 100 pixels */
      [data-tiny-image="true"] {
        padding: 0.25em 0em !important;
      }

      [data-revealed="false"] {
        display: none;
      }

      #image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        object-position: 0 0;
      }

      @-webkit-keyframes fadein {
        from { opacity: 0; }
        to   { opacity: 1; }
      }

      #meta {
        max-width: 100%;
      }
    </style>

    <div id="container" on-mouseover="{{revealmetaOn}}" on-mouseout="{{revealmetaOff}}">
      <img id="image" src="{{src}}" on-load="{{imageLoaded}}" on-error="{{imageError}}">
      <p id="meta" data-revealed="{{revealmeta === 'on' || revealmeta === 'always'}}"
         data-tiny-image="{{isTinyImage}}">
        {{width}}x{{height}}
      </p>
    </div>
  </template>

  <script>
    (function () {
      // timeout (in ms) before treating an image load as failed
      var TIMEOUT = 5000;

      Polymer({
        created: function () {
          // URL for the image to display
          this.src = null;

          // width, height and ratio are set when the wrapped image has loaded
          this.width = 0;
          this.height = 0;
          this.ratio = 0;

          // true if the wrapped image's load event has fired
          this.setAttribute('loaded', false);

          // true if the image is ready, whether it loaded or failed
          this.setAttribute('done', false);

          // true if the image's width is less than 100px
          this.isTinyImage = false;

          // set to 'on' to reveal metadata; set to 'off' to hide it;
          // set to 'always' if metadata should always be visible
          this.revealmeta = 'off';

          this.keyword = null;
        },

        revealmetaOn: function () {
          if (this.revealmeta === 'always') {
            return;
          }

          this.revealmeta = 'on';
        },

        revealmetaOff: function () {
          if (this.revealmeta === 'always') {
            return;
          }

          this.revealmeta = 'off';
        },

        srcChanged: function () {
          var self = this;

          this.loaded = false;

          // fire a "done" event, even if the image times out
          this.timeout = setTimeout(function () {
            if (!self.loaded) {
              self.setAttribute('done', true);
              self.fire('done');
            }
          }, TIMEOUT);
        },

        // set metadata for the image once it's loaded
        imageLoaded: function () {
          this.height = this.$.image.height;
          this.width = this.$.image.width;

          if (this.height > 0) {
            this.ratio = this.width / this.height;
          }

          // mark tiny images so the metadata display can be adjusted
          this.isTinyImage = (this.width < 100);

          this.setAttribute('loaded', true);
          this.setAttribute('done', true);
          this.fire('done', this);
        },

        // image failed to load for whatever reason
        imageError: function (e) {
          this.setAttribute('loaded', false);
          this.setAttribute('done', true);
          this.fire('done', this);

          // notify the error, in case anyone cares
          this.fire('error', e);
        }
      });
    })();
  </script>
</polymer-element>
