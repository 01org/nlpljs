<polymer-element name="cp-scrollwatcher">
  <template></template>
  <script>
    (function () {
      var scrollableNode;

      var isNodeVisible = function (node) {
        var boundingRectangle = node.getBoundingClientRect();
        var nodeStyle = document.defaultView.getComputedStyle(node, null);

        if ('0' === nodeStyle['opacity'] || 'none' === nodeStyle['display'] ||
            'hidden' === nodeStyle['visiblity'])
          return false;

        return (
          boundingRectangle.bottom > 0 &&
          boundingRectangle.right > 0 &&
          boundingRectangle.left < (window.innerWidth ||
            document.documentElement.clientWidth) &&
          boundingRectangle.top < (window.innerHeight ||
            document.documentElement.clientHeight)
        );
      };

      Polymer({
        setScrollableNode: function (node) {
          scrollableNode = node;
        },
        addOnScrollListener: function (listener) {
          var onScroll = function () {
            var visibleNodes = [];
            var hiddenNodes = [];

            if (typeof targetNodes !== 'undefined') {
              for (var i = 0; i < targetNodes.length; i++) {
                if (isNodeVisible(targetNodes[i]))
                  visibleNodes[visibleNodes.length] = targetNodes[i];
                else
                  hiddenNodes[hiddenNodes.length] = targetNodes[i];
              }
            }

            listener(visibleNodes, hiddenNodes);
          };

          if (typeof scrollableNode !== 'undefined')
            scrollableNode.addEventListener('scroll', onScroll, false);

          window.addEventListener('DOMContentLoaded', onScroll, false); 
          window.addEventListener('load', onScroll, false); 
          window.addEventListener('scroll', onScroll, false); 
          window.addEventListener('resize', onScroll, false);
        },
        setTargetNodes: function (nodes) {
          targetNodes = nodes;
        }
      });
    })();
  </script>
</polymer-element>
