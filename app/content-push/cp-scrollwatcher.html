<polymer-element name="cp-scrollwatcher">
  <template></template>
  <script>
    (function () {
      var scrollableNode;
      var targetNodes = [];
      var timeout = 500;
      var scrollTimer;

      var isNodeVisible = function (node) {
        var boundingRectangle = node.getBoundingClientRect();
        var parentBoundingRectangle;

        var nodeStyle = document.defaultView.getComputedStyle(node, null);

        if ('0' === nodeStyle['opacity'] || 'none' === nodeStyle['display'] ||
            'hidden' === nodeStyle['visiblity'])
          return false;

        if (typeof scrollableNode !== 'undefined') {
          parentBoundingRectangle = scrollableNode.getBoundingClientRect();

          if (boundingRectangle.bottom > parentBoundingRectangle.bottom ||
              boundingRectangle.right > parentBoundingRectangle.right ||
              boundingRectangle.left < parentBoundingRectangle.left ||
              boundingRectangle.top < parentBoundingRectangle.top)
            return false;
        }

        if (boundingRectangle.bottom > window.innerHeight ||
            boundingRectangle.right > window.innerWidth ||
            boundingRectangle.left < 0 ||
            boundingRectangle.top < 0)
          return false;

       return true;
      };

      Polymer({
        setScrollableNode: function (node) {
          scrollableNode = node;
        },
        addOnScrollListener: function (listener) {
          var onScroll = function () {
            clearTimeout(scrollTimer);
            scrollTimer = setTimeout(function () {
              var visibleNodes = [];
              var hiddenNodes = [];

              if (typeof targetNodes !== 'undefined') {
                for (var i = 0; i < targetNodes.length; i++) {
                  if (isNodeVisible(targetNodes[i]))
                    visibleNodes[visibleNodes.length] = targetNodes[i];
                  else
                    hiddenNodes[hiddenNodes.length] = targetNodes[i];
                }
              }

              listener(visibleNodes, hiddenNodes);
            }, timeout);
          };

          if (typeof scrollableNode !== 'undefined')
            scrollableNode.addEventListener('scroll', onScroll, false);

          window.addEventListener('DOMContentLoaded', onScroll, false); 
          window.addEventListener('load', onScroll, false); 
          window.addEventListener('scroll', onScroll, false); 
          window.addEventListener('resize', onScroll, false);
        },
        addTargetNode: function (targetNode) {
          targetNodes[targetNodes.length] = targetNode;
        },
        setScrollTimeout: function (scrollTimeout) {
          timeout = scrollTimeout;
        }
      });
    })();
  </script>
</polymer-element>
