/* example url and server response, for reference
https://www.googleapis.com/customsearch/v1?searchType=image&key=AIzaSyARyiQ40rIjCtqtamRW98McMrU1gFgDPDE&cx=010167764530769062315:196d4y__4ss&safe=high&num=10&start=1&q=%22battle
{
 "kind": "customsearch#search",
 "url": {
  "type": "application/json",
  "template": "https://www.googleapis.com/customsearch/v1?q={searchTerms}&num={count?}&start={startIndex?}&lr={language?}&safe={safe?}&cx={cx?}&cref={cref?}&sort={sort?}&filter={filter?}&gl={gl?}&cr={cr?}&googlehost={googleHost?}&c2coff={disableCnTwTranslation?}&hq={hq?}&hl={hl?}&siteSearch={siteSearch?}&siteSearchFilter={siteSearchFilter?}&exactTerms={exactTerms?}&excludeTerms={excludeTerms?}&linkSite={linkSite?}&orTerms={orTerms?}&relatedSite={relatedSite?}&dateRestrict={dateRestrict?}&lowRange={lowRange?}&highRange={highRange?}&searchType={searchType}&fileType={fileType?}&rights={rights?}&imgSize={imgSize?}&imgType={imgType?}&imgColorType={imgColorType?}&imgDominantColor={imgDominantColor?}&alt=json"
 },
 "queries": {

  "nextPage": [
   {
    "title": "Google Custom Search - \"battle",
    "totalResults": "162000000",
    "searchTerms": "\"battle",
    "count": 10,
    "startIndex": 11,
    "inputEncoding": "utf8",
    "outputEncoding": "utf8",
    "safe": "high",
    "cx": "010167764530769062315:196d4y__4ss",
    "searchType": "image"
   }
  ],

  "request": [
   {
    "title": "Google Custom Search - \"battle",
    "totalResults": "162000000",
    "searchTerms": "\"battle",
    "count": 10,
    "startIndex": 1,
    "inputEncoding": "utf8",
    "outputEncoding": "utf8",
    "safe": "high",
    "cx": "010167764530769062315:196d4y__4ss",
    "searchType": "image"
   }
  ]
 },
 "context": {
  "title": "Content Push"
 },
 "searchInformation": {
  "searchTime": 0.314072,
  "formattedSearchTime": "0.31",
  "totalResults": "162000000",
  "formattedTotalResults": "162,000,000"
 },
 "items": [
  {
   "kind": "customsearch#result",
   "title": "The Daily Battle - CrossFit LittletonCrossFit Littleton",
   "htmlTitle": "The Daily \u003cb\u003eBattle\u003c/b\u003e - CrossFit LittletonCrossFit Littleton",
   "link": "http://crossfitlittleton.net/wp-content/blogs.dir/29/files/2014/06/battle.jpg",
   "displayLink": "crossfitlittleton.net",
   "snippet": "battle",
   "htmlSnippet": "\u003cb\u003ebattle\u003c/b\u003e",
   "mime": "image/jpeg",
   "image": {
    "contextLink": "http://crossfitlittleton.net/2014/06/26/daily-battle/",
    "height": 1200,
    "width": 1920,
    "byteSize": 567508,
    "thumbnailLink": "https://encrypted-tbn1.gstatic.com/images?q=tbn:ANd9GcSldj546EX2xxEAHDfTGZrAWKdlspbhRDsylLKmx8vLQJmg4ByoJGOWaFss",
    "thumbnailHeight": 94,
    "thumbnailWidth": 150
   }
  },
  {
   "kind": "customsearch#result",
   "title": "Battle of Glorieta Pass - Pecos National Historical Park (U.S. ...",
   "htmlTitle": "\u003cb\u003eBattle\u003c/b\u003e of Glorieta Pass - Pecos National Historical Park (U.S. \u003cb\u003e...\u003c/b\u003e",
   "link": "http://www.nps.gov/peco/historyculture/images/The-Battle-of-Glorieta-Pass.jpg",
   "displayLink": "www.nps.gov",
   "snippet": "Battle of Glorieta Pass",
   "htmlSnippet": "\u003cb\u003eBattle\u003c/b\u003e of Glorieta Pass",
   "mime": "image/jpeg",
   "image": {
    "contextLink": "http://www.nps.gov/peco/historyculture/copy-of-battleofglorietta.htm",
    "height": 345,
    "width": 556,
    "byteSize": 79598,
    "thumbnailLink": "https://encrypted-tbn2.gstatic.com/images?q=tbn:ANd9GcQjd4bzjNyy9Bs3el4TkEX5eN-Hzjoe98UA04LGB1YCgQyGHMpDiR_JOC4",
    "thumbnailHeight": 83,
    "thumbnailWidth": 133
   }
  },
  {
   "kind": "customsearch#result",
   "title": "Battle of Orsha - Wikipedia, the free encyclopedia",
   "htmlTitle": "\u003cb\u003eBattle\u003c/b\u003e of Orsha - Wikipedia, the free encyclopedia",
   "link": "http://upload.wikimedia.org/wikipedia/commons/b/b9/Krell_Battle_of_Orsha_01.jpg",
   "displayLink": "en.wikipedia.org",
   "snippet": "Battle of Orsha",
   "htmlSnippet": "\u003cb\u003eBattle\u003c/b\u003e of Orsha",
   "mime": "image/jpeg",
   "image": {
    "contextLink": "http://en.wikipedia.org/wiki/Battle_of_Orsha",
    "height": 1568,
    "width": 2500,
    "byteSize": 1731647,
    "thumbnailLink": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSpUAlkkA6VH9AIRHzVcTbj3U_8d4OhGyyiuoHg8eDi69a8KhVcspJ7WDA",
    "thumbnailHeight": 94,
    "thumbnailWidth": 150
   }
  },
  {
   "kind": "customsearch#result",
   "title": "Battle of the Rich Mountain",
   "htmlTitle": "\u003cb\u003eBattle\u003c/b\u003e of the Rich Mountain",
   "link": "http://www.sonofthesouth.net/leefoundation/rich-mountain/battle-rich-mountain.jpg",
   "displayLink": "www.sonofthesouth.net",
   "snippet": "Civil War Battle of Rich",
   "htmlSnippet": "Civil War \u003cb\u003eBattle\u003c/b\u003e of Rich",
   "mime": "image/jpeg",
   "image": {
    "contextLink": "http://www.sonofthesouth.net/leefoundation/battle-rich-mountain.htm",
    "height": 1424,
    "width": 1808,
    "byteSize": 790502,
    "thumbnailLink": "https://encrypted-tbn1.gstatic.com/images?q=tbn:ANd9GcQV0mz-Yot-ZEMkyTQeZ5njLIaltHC60UjnO5eqcWVsy-lLqL2aPrVxBrlD",
    "thumbnailHeight": 118,
    "thumbnailWidth": 150
   }
  },
  {
   "kind": "customsearch#result",
   "title": "Battle of Waterloo - Wikipedia, the free encyclopedia",
   "htmlTitle": "\u003cb\u003eBattle\u003c/b\u003e of Waterloo - Wikipedia, the free encyclopedia",
   "link": "http://upload.wikimedia.org/wikipedia/commons/7/72/Battle_of_Waterloo_1815.PNG",
   "displayLink": "en.wikipedia.org",
   "snippet": "Battle of Waterloo 1815.PNG",
   "htmlSnippet": "\u003cb\u003eBattle\u003c/b\u003e of Waterloo 1815.PNG",
   "mime": "image/png",
   "fileFormat": "Image Document",
   "image": {
    "contextLink": "http://en.wikipedia.org/wiki/Battle_of_Waterloo",
    "height": 846,
    "width": 1854,
    "byteSize": 3192839,
    "thumbnailLink": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR9IeVkhBatTenB3pRnS8S3RhQqIXd946jJhaCjkgRYVQ4I0DbPIhLMmGE",
    "thumbnailHeight": 68,
    "thumbnailWidth": 150
   }
  },
  {
   "kind": "customsearch#result",
   "title": "Battle of Chattanooga - American Civil War - HISTORY.",
   "htmlTitle": "\u003cb\u003eBattle\u003c/b\u003e of Chattanooga - American Civil War - HISTORY.",
   "link": "http://cdn.history.com/sites/2/2013/11/Battle-of-Chattanooga-Hero-H.jpeg",
   "displayLink": "www.history.com",
   "snippet": "american civil war, battle of",
   "htmlSnippet": "american civil war, \u003cb\u003ebattle\u003c/b\u003e of",
   "mime": "image/jpeg",
   "image": {
    "contextLink": "http://www.history.com/topics/american-civil-war/battle-of-chattanooga",
    "height": 454,
    "width": 1389,
    "byteSize": 739737,
    "thumbnailLink": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTVe4n4ItggHBb7M-Bn6Rqoeu8OObQZ3wdfyLqTepDA2cJ4BMwk2ZIwkKA",
    "thumbnailHeight": 49,
    "thumbnailWidth": 150
   }
  },
  {
   "kind": "customsearch#result",
   "title": "Richard III - Tewkesbury",
   "htmlTitle": "Richard III - Tewkesbury",
   "link": "http://www.richard111.com/Battle%20of%20Tewkesbury.JPG",
   "displayLink": "www.richard111.com",
   "snippet": "May 4, 1471",
   "htmlSnippet": "May 4, 1471",
   "mime": "image/jpeg",
   "image": {
    "contextLink": "http://www.richard111.com/tewkesbury1.htm",
    "height": 915,
    "width": 1524,
    "byteSize": 452972,
    "thumbnailLink": "https://encrypted-tbn1.gstatic.com/images?q=tbn:ANd9GcRNxCOpSAja_UycDcW_FuPVeLzcq1QePOsb5IdFPHRsSKdFhwzxdc7i9TpU",
    "thumbnailHeight": 90,
    "thumbnailWidth": 150
   }
  },
  {
   "kind": "customsearch#result",
   "title": "Battle of Bosworth Field - Wikipedia, the free encyclopedia",
   "htmlTitle": "\u003cb\u003eBattle\u003c/b\u003e of Bosworth Field - Wikipedia, the free encyclopedia",
   "link": "http://upload.wikimedia.org/wikipedia/commons/1/11/Battle_of_Bosworth_Field_diorama.jpg",
   "displayLink": "en.wikipedia.org",
   "snippet": "Miniatures of knights, archers",
   "htmlSnippet": "Miniatures of knights, archers",
   "mime": "image/jpeg",
   "image": {
    "contextLink": "http://en.wikipedia.org/wiki/Battle_of_Bosworth_Field",
    "height": 846,
    "width": 1280,
    "byteSize": 294121,
    "thumbnailLink": "https://encrypted-tbn3.gstatic.com/images?q=tbn:ANd9GcRrSiSOvQ-TFH5d04pOBVa8gUv8nlIHpdL1P0Xw_-yie7UPuNEtgrph8Jo",
    "thumbnailHeight": 99,
    "thumbnailWidth": 150
   }
  },
  {
   "kind": "customsearch#result",
   "title": "Spanish Succession : Battle of Ramillies",
   "htmlTitle": "Spanish Succession : \u003cb\u003eBattle\u003c/b\u003e of Ramillies",
   "link": "http://www.britishbattles.com/spanish-succession/ramillies/battle-ramilles-1200.jpg",
   "displayLink": "www.britishbattles.com",
   "snippet": "The Battle of Ramilles:",
   "htmlSnippet": "The \u003cb\u003eBattle\u003c/b\u003e of Ramilles:",
   "mime": "image/jpeg",
   "image": {
    "contextLink": "http://www.britishbattles.com/spanish-succession/battle-ramillies.htm",
    "height": 911,
    "width": 1200,
    "byteSize": 289254,
    "thumbnailLink": "https://encrypted-tbn2.gstatic.com/images?q=tbn:ANd9GcSfDvnLRVEm5NhCo08xGQ-VC2AduiOa4TS8wSoJIGl7YV9_x4YDfQN7W4Ux",
    "thumbnailHeight": 114,
    "thumbnailWidth": 150
   }
  },
  {
   "kind": "customsearch#result",
   "title": "File:Battle of Franklin, November 30, 1864.jpg - Wikimedia Commons",
   "htmlTitle": "File:\u003cb\u003eBattle\u003c/b\u003e of Franklin, November 30, 1864.jpg - Wikimedia Commons",
   "link": "http://upload.wikimedia.org/wikipedia/commons/6/6e/Battle_of_Franklin,_November_30,_1864.jpg",
   "displayLink": "commons.wikimedia.org",
   "snippet": "File:Battle of Franklin,",
   "htmlSnippet": "File:\u003cb\u003eBattle\u003c/b\u003e of Franklin,",
   "mime": "image/jpeg",
   "image": {
    "contextLink": "http://commons.wikimedia.org/wiki/File:Battle_of_Franklin,_November_30,_1864.jpg",
    "height": 5149,
    "width": 7393,
    "byteSize": 9066133,
    "thumbnailLink": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ4a_ZdPqAq7dG3QlCfcMg33C7L7brHjlqykLi3fjrle04uiC_MPLWj__4T",
    "thumbnailHeight": 104,
    "thumbnailWidth": 150
   }
  }
 ]
}
*/

var sizeOf = require('image-size');
var http = require('http');
var fs = require('fs');

function makeContainerObject() {
  return {
 "kind": "customsearch#search",
 "url": {
  "type": "application/json",
  "template": "https://www.googleapis.com/customsearch/v1?q={searchTerms}&num={count?}&start={startIndex?}&lr={language?}&safe={safe?}&cx={cx?}&cref={cref?}&sort={sort?}&filter={filter?}&gl={gl?}&cr={cr?}&googlehost={googleHost?}&c2coff={disableCnTwTranslation?}&hq={hq?}&hl={hl?}&siteSearch={siteSearch?}&siteSearchFilter={siteSearchFilter?}&exactTerms={exactTerms?}&excludeTerms={excludeTerms?}&linkSite={linkSite?}&orTerms={orTerms?}&relatedSite={relatedSite?}&dateRestrict={dateRestrict?}&lowRange={lowRange?}&highRange={highRange?}&searchType={searchType}&fileType={fileType?}&rights={rights?}&imgSize={imgSize?}&imgType={imgType?}&imgColorType={imgColorType?}&imgDominantColor={imgDominantColor?}&alt=json"
 },
 "queries": {
  "nextPage": [
   {
    "title": "Google Custom Search - \"battle",
    "totalResults": "162000000",
    "searchTerms": "\"battle",
    "count": 10,
    "startIndex": 11,
    "inputEncoding": "utf8",
    "outputEncoding": "utf8",
    "safe": "high",
    "cx": "010167764530769062315:196d4y__4ss",
    "searchType": "image"
   }
  ],
  "request": [
   {
    "title": "Google Custom Search - \"battle",
    "totalResults": "162000000",
    "searchTerms": "\"battle",
    "count": 10,
    "startIndex": 1,
    "inputEncoding": "utf8",
    "outputEncoding": "utf8",
    "safe": "high",
    "cx": "010167764530769062315:196d4y__4ss",
    "searchType": "image"
   }
  ]
 },
 "context": {
  "title": "Content Push"
 },
 "searchInformation": {
  "searchTime": 0.314072,
  "formattedSearchTime": "0.31",
  "totalResults": "162000000",
  "formattedTotalResults": "162,000,000"
 },
 "items": [
 ]
};

}

function makeImageObject(imagePath) {
  var dimensions = sizeOf(imagePath);
  var stats = fs.statSync(imagePath)
  var fileSizeInBytes = stats["size"]

  return {
    // properties for images
   "kind": "customsearch#result",
   "title": "The Daily Battle - CrossFit LittletonCrossFit Littleton",
   "htmlTitle": "The Daily \u003cb\u003eBattle\u003c/b\u003e - CrossFit LittletonCrossFit Littleton",
   "link": "http://127.0.0.1:1337/"+imagePath,
   "displayLink": "crossfitlittleton.net",
   "snippet": "battle",
   "htmlSnippet": "\u003cb\u003ebattle\u003c/b\u003e",
   "mime": "image/jpeg",
   "image": {
    "contextLink": "http://crossfitlittleton.net/2014/06/26/daily-battle/",
    "height": dimensions.height,
    "width": dimensions.width,
    "byteSize": fileSizeInBytes,
    "thumbnailLink": "http://127.0.0.1:1337/"+imagePath,
    "thumbnailHeight": dimensions.height/10,
    "thumbnailWidth": dimensions.width/10,

    // properties for articles - must be missing something, probably the container object is different too
    "pagemap": {
      "cse_image": [
        { "src": "http://127.0.0.1:1337/"+imagePath }
      ],
    },
    "snippet": "Nov 13, 2014 ... From Yahoo News: In a town called Hastings in western Sierra Leone a battle every bit as deadly as the Norman Conquest is being fought ..."
   }
  }
}

function makeHeader() {
  return {
'Content-Type': 'application/json; charset=UTF-8',
  };
}

fs.readdir('.',function(err, files) {
  http.createServer(function (req, res) {
    if (req.url.indexOf('key=')!=-1) {
      console.log('api request');
      res.writeHead(200, makeHeader());
      var retVal = makeContainerObject();
      for (var image=0; image<10; image++) {
        var imagePath = files[Math.floor(Math.random()*files.length)];
        retVal.items.push( makeImageObject(imagePath) );
      }
      var json = JSON.stringify(retVal);
      res.write(json);
      res.end();
    } else {
      var imageName = req.url.substring(1);
      console.log(imageName);
      var img = fs.readFileSync(imageName);
      res.writeHead(200, { 'Content-Type': 'image/jpeg' } );
      res.write(img, 'binary');
      res.end();
    }
  }).listen(1337, '127.0.0.1');
  console.log('Server running at http://127.0.0.1:1337/');
});
