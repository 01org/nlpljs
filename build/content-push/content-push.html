<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-splitter/core-splitter.html">
<link rel="import" href="../bower_components/core-component-page/core-component-page.html">
<!--link rel="import" href="../bower_components/paper-button/paper-button.html"-->

<polymer-element name="content-push" attributes="iframeurl">
  <template>
    <style>
      :host {
        display: block;
        width: 100%;
        height: 100%;
        background-color: cyan;
      }

      #container {
        height: 100%;
      }

      #iframe {
        display: inline-block;
        background-color: red;
        height: 100%;
      }

      #content_push_panel {
        display: inline-block;
        background-color: blue;
        height: 100%;
        width: 25%;
        max-width: 35%;
      }

      img {
        max-width: 50%;
        height: auto;
      }
    </style>
    <div id="container" horizontal layout>
      <iframe id="iframe" flex></iframe>
      <core-splitter direction="right" on-down="{{downAction}}" on-up="{{upAction}}"></core-splitter>
      <div id="content_push_panel">
        <h4>Multiple lines on frame load</h4>
        <p id="multiple_lines"></p>
        <h4>Updated when text is changed</h4>
        <p id="changed_text">(nothing changed yet)</p>
        <h4>Get images for changed text</h4>
        <button id="image_button" on-click="{{getImages}}">Go!</button>
        <h4>Images</h4>
        <core-xhr id="google_images"></core-xhr>
        <div id="images"></div>
      </div>
    </div>
  </template>
  <script>
    (function() {
      // private properties

      // find ancestor of node that has className
      // for finding the ancestor with .kix-lineview of whatever line has changed
      var findAncestor = function(node,className) {
        var retVal=null;

        var thisNode=node;
        var cssSelectorNotFound=true;

        while (cssSelectorNotFound && thisNode && thisNode.nodeName!="BODY") {
          cssSelectorNotFound=!thisNode.classList.contains(className);
          if (cssSelectorNotFound) {
            // move into parent node
            thisNode=thisNode.parentNode;
          } else {
            // finished
            retVal=thisNode;
          }
        }

        return retVal;
      };

      // NOTE: doesn't handle removed lines
      var observeDocumentChanges = function(iframe,callBack) {
        var docsContainerSelector = ".kix-paginateddocumentplugin";
        var docsFilterSelector = ".kix-lineview";

        // Create an observer instance
        var observer = new MutationObserver(function(mutations,observerInstance) {
          mutations.forEach(function(mutation) {
            var newNodes = mutation.addedNodes; // DOM NodeList
            if (newNodes !== null) { // If there are new nodes added
              for (var i=0;i<newNodes.length;++i) {
                var thisNode=newNodes[i];
                if (thisNode) {
                  var lineview=(thisNode.classList.contains("kix-lineview"))?thisNode:findAncestor(thisNode,"kix-lineview");
                  if (lineview) {
                    callBack(lineview.textContent);
                  }
                }
              }
            }
          });
        });

        // Configuration of the observer:
        var config = {
          attributes: true,
          childList: true,
          subtree: true,
          characterData: true
        };

        // Pass in the target node, as well as the observer options
        var node=iframe.contentDocument.querySelector(docsContainerSelector);
        observer.observe(node, config);
      };

      // contruct polymer element
      Polymer({
        created: function() {
          this.iframeurl="";

          // from https://console.developers.google.com/project
          this.googleImages_key = 'AIzaSyALRtaOgPBIkxDeCr10JBnCtrIo3uahgmg';

          // from https://www.google.com/cse/manage/all
          this.googleImages_cseId = '009009366889943162389:qxyeiz__u68';

          this.googleImages_baseUrl = 'https://www.googleapis.com/customsearch/v1';
        },

        iframeurlChanged: function(oldValue,newValue) {
          console.log("CP:new iframeurl:",newValue);
          self.$.iframe.src=newValue;
        },

        ready: function() {
          self=this;
          console.log("CP:iframeurl:",self.iframeurl);
          self.$.iframe.src=self.iframeurl;

          self.$.iframe.onload=function() {
            console.log("CP:iframe onload");
            // demonstrate stuff can be copied from the iframe document
            var totalLinesToAdd=5;
            var textToAdd = "";
            var lines=self.$.iframe.contentDocument.querySelectorAll(".kix-lineview");
            for( var i=0; i<totalLinesToAdd; ++i) {
              var text=lines[i].textContent;
              textToAdd+=text;
            }

            var textNode=document.createTextNode(textToAdd.replace("&nbsp;"," "));
            self.$.multiple_lines.appendChild(textNode);

            observeDocumentChanges(self.$.iframe, function(text) {
              var textNode=document.createTextNode(text.replace("&nbsp;"," "));
              self.$.changed_text.innerHTML="";
              self.$.changed_text.appendChild(textNode);
            });
          };
        },

        search: function (query) {
          var handler = this.handleGoogleImagesResponse.bind(this);

          var searchParams = {
            searchType: 'image',
            key: this.googleImages_key,
            cx: this.googleImages_cseId,
            q: query
          };

          this.$.google_images.request({
            url: this.googleImages_baseUrl,
            params: searchParams,
            responseType: 'json',
            callback: handler
          });
        },

        handleGoogleImagesResponse: function (response) {
          if (response.error) {
            console.log("CP:error from Google:",response.error.message);
          } else {
            var img;
            for (var i = 0; i < response.items.length; i++) {
              img = document.createElement('img');
              img.src = response.items[i].link;
              this.$.images.appendChild(img);
            }
          }

        },

        getImages: function() {
          this.search(this.$.changed_text.innerText);
        },

        downAction: function() {
          this.$.iframe.style.pointerEvents = 'none';
        },
        upAction: function() {
          this.$.iframe.style.pointerEvents = '';
        },
      });
    })();
  </script>
</polymer-element>
